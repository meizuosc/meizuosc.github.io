<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="baidu-site-verification" content="093lY4ziMu" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="一个有内涵的技术分享平台">
    <meta name="keyword"  content="meizu,kernel,魅族">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!--<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>-->
    <title>
        
          Device Tree 详解 - 魅族内核团队
        
    </title>

    <link rel="canonical" href="https://kernel.meizu.com/2018/03/20//device-tree.html/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="../../../../../css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
        
<link rel="stylesheet" href="../../../../../css/dusign-light.css">

        
<link rel="stylesheet" href="../../../../../css/dusign-common-light.css">

        
<link rel="stylesheet" href="../../../../../css/font-awesome.css">

        
<link rel="stylesheet" href="../../../../../css/toc.css">

        <!-- background effects end -->
    
    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="../../../../../css/highlight.css">


    
<link rel="stylesheet" href="../../../../../css/widget.css">


    
<link rel="stylesheet" href="../../../../../css/rocket.css">


    
<link rel="stylesheet" href="../../../../../css/signature.css">


    
<link rel="stylesheet" href="../../../../../css/fonts.googleapis.css">


    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- photography -->
    
<link rel="stylesheet" href="../../../../../css/photography.css">


    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- background effects start -->
    
    <!-- background effects end -->

	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            
                background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('')
                /*post*/
            
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#DTS" title="DTS">DTS</a>
                            
                              <a class="tag" href="/tags/#DTB" title="DTB">DTB</a>
                            
                              <a class="tag" href="/tags/#DTC" title="DTC">DTC</a>
                            
                              <a class="tag" href="/tags/#Node" title="Node">Node</a>
                            
                              <a class="tag" href="/tags/#Property" title="Property">Property</a>
                            
                              <a class="tag" href="/tags/#OpenFirmware" title="OpenFirmware">OpenFirmware</a>
                            
                        </div>
                        <h1>Device Tree 详解</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Peng Weilin on
                            2018-03-20
                        </span>

                        

                    </div>
                

                </div>
            </div>
        </div>      
    </div>

    
    <div class="waveWrapper">
        <div class="wave wave_before" style="background-image: url('/img/wave-light.png')"></div>
        <div class="wave wave_after" style="background-image: url('/img/wave-light.png')"></div>
    </div>
    
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">魅族内核团队</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/categories/">Categories</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="1、DTS语法"><a href="#1、DTS语法" class="headerlink" title="1、DTS语法"></a>1、DTS语法</h1><p>对于DeviceTree的来历和用处大部分人都已经非常了解了，DeviceTree发源于PowerPC架构，为了消除代码中冗余的各种device注册代码而产生的，现在已经成为了linux的通用机制。</p>
<p>DeviceTree的结构非常简单，由两种元素组成：Node(节点)、Property(属性)。下图是一个真实的简单的DeviceTree树形结构图。</p>
<p><img src="DeviceTree.png" alt="image"></p>
<ul>
<li>Node节点。在DTS中使用一对花括号”node-name{}”来定义;</li>
<li>Property属性。在Node中使用”property-name=value”字符串来定义；</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">/ &#123;</span></span><br><span class="line"><span class="class">	model = <span class="string">"mt6799"</span>;</span></span><br><span class="line"><span class="class">	compatible = <span class="string">"mediatek,mt6799"</span>;</span></span><br><span class="line"><span class="class">	interrupt-parent = <span class="params">&lt;<span class="variable">&amp;gic</span>&gt;</span>;</span></span><br><span class="line"><span class="class">	#address-cells = <span class="params">&lt;<span class="number">2</span>&gt;</span>;</span></span><br><span class="line"><span class="class">	#size-cells = <span class="params">&lt;<span class="number">2</span>&gt;</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">	<span class="comment">/* chosen */</span></span></span><br><span class="line"><span class="class">	<span class="class">chosen </span>&#123;</span></span><br><span class="line"><span class="class">		bootargs = <span class="string">"console=tty0 console=ttyMT0,921600n1 root=/dev/ram"</span>;</span></span><br><span class="line"><span class="class">	&#125;;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述例子中定义了一个根节点”/“和一个子节点“chosen”，其他的字符串“model = “mt6799”;”、“compatible = “mediatek,mt6799”;”都是property。</p>
<p>Node、Property的名字和值都是可以自定义的，没有太大限制。但是DeviceTree的标准还是预定义了一些标准的Node和Property，在标准Node和Property之间还定义了一些约束规则。关于这些描述在 <a href="https://www.devicetree.org/" target="_blank" rel="noopener">The DeviceTree Specification</a>官方spec中有详细描述。这里为了方便大家，还是重复做一些搬运。</p>
<h2 id="1-1、标准Property"><a href="#1-1、标准Property" class="headerlink" title="1.1、标准Property"></a>1.1、标准Property</h2><p>Property的格式为”property-name=value”，其中value的取值类型如下：</p>
<table border="1">
<caption> Property values： </caption>

<tr>
<th style="width: 200px;">Value</th>
<th style="width: 600px;">Description</th>
</tr>

<tr>
<td> &#60;empty&#62; </td>
<td>
Value is empty. Used for conveying true-false information, when the presence of
absence of the property itself is sufficiently descriptive.<br /><br />
Property值为空，用property本身出现或者不出现来表示一个treue/false值。
</td>
</tr>

<tr>
<td> &#60;u32&#62; </td>
<td>
A 32-bit integer in big-endian format. Example: the 32-bit value 0x11223344 would be represented in memory as: <br />
address 11<br />
address+1 22<br />
address+2 33<br />
address+3 44<br /><br />
32bit的值，用大端格式存储。
</td>
</tr>

<tr>
<td> &#60;u64&#62; </td>
<td>
Represents a 64-bit integer in big-endian format. Consists of two &#60;u32&#62; values where the first value contains the most significant bits of the integer and the second value contains the least significant bits.<br />
Example: the 64-bit value 0x1122334455667788 would be represented as two cells as: <0x11223344 0x55667788>. <br />
The value would be represented in memory as:<br />
address 11<br />
address+1 22<br />
address+2 33<br />
address+3 44<br />
address+4 55<br />
address+5 66<br />
address+6 77<br />
address+7 88<br /><br />
64bit的值，用大端格式存储。
</td>
</tr>

<tr>
<td> &#60;string&#62; </td>
<td>
Strings are printable and null-terminated. Example: the string “hello” would be represented in memory as:<br />
address 68 'h'<br />
address+1 65 'e'<br />
address+2 6C 'l'<br />
address+3 6C 'l'<br />
address+4 6F 'o'<br />
address+5 00 '\0'<br /><br />
字符串。
</td>
</tr>

<tr>
<td> &#60;prop-encoded-array&#62; </td>
<td>
Format is specific to the property. See the property definition.<br /><br />
混合编码，自定义property的值。
</td>
</tr>

<tr>
<td> &#60;phandle&#62; </td>
<td>
A &#60;u32&#62; value. A phandle value is a way to reference another node in the devicetree.<br />
Any node that can be referenced defines a phandle property with a unique &#60;u32&#62;
value. That number is used for the value of properties with a phandle value type.<br /><br />
作为一个句柄指向一个Node，用来引用Node。
</td>
</tr>

<tr>
<td> &#60;stringlist&#62; </td>
<td>
A list of &#60;string&#62; values concatenated together.<br />
Example: The string list “hello”,”world” would be represented in memory as:<br />
address 68 'h'<br />
address+1 65 'e'<br />
address+2 6C 'l'<br />
address+3 6C 'l'<br />
address+4 6F 'o'<br />
address+5 00 '\0'<br />
address+6 77 'w'<br />
address+7 6f 'o'<br />
address+8 72 'r'<br />
address+9 6C 'l'<br />
address+10 64 'd'<br />
address+11 00 '\0'<br /><br />
字符串数组。
</td>
</tr>

</table>

<h3 id="1-1-1、compatible"><a href="#1-1-1、compatible" class="headerlink" title="1.1.1、compatible"></a>1.1.1、compatible</h3><ul>
<li>“compatible”属性通常用来device和driver的适配，推荐的格式为”manufacturer,model”。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">compatible</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;stringlist&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
The compatible property value consists of one or more strings that define the specific programming model for the device. This list of strings should be used by a client program for device driver selection. The property value consists of a concatenated list of null terminated strings, from most specific to most general. They allow a device to express its compatibility with a family of similar devices, potentially allowing a single device driver to match against several devices.<br />
The recommended format is "manufacturer,model", where manufacturer is a string describing the name of the manufacturer (such as a stock ticker symbol), and model specifies the model number.<br /><br />
</td>
</tr>

<tr>
<td> Example: </td>
<td>
compatible = "fsl,mpc8641", "ns16550"; <br /><br />
In this example, an operating system would first try to locate a device driver that supported fsl,mpc8641. If a driver was not found, it would then try to locate a driver that supported the more general ns16550 device type.<br /><br />
在这个例子中，device首先尝试去适配"fsl,mpc8641"driver，如果失败再去尝试适配"ns16550"driver。
</td>
</tr>

</table>

<h3 id="1-1-2、model"><a href="#1-1-2、model" class="headerlink" title="1.1.2、model"></a>1.1.2、model</h3><ul>
<li>“model”属性只是简单的表示型号，root节点用其来传递值给machine_desc_str。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">model</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;stringlist&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
The model property value is a &#60;string&#62; that specifies the manufacturer’s model number of the device.<br />
The recommended format is: "manufacturer,model", where manufacturer is a string describing the name of the manufacturer (such as a stock ticker symbol), and model specifies the model number.
</td>
</tr>

<tr>
<td> Example: </td>
<td>
model = "fsl,MPC8349EMITX";
</td>
</tr>

</table>

<h3 id="1-1-3、phandle"><a href="#1-1-3、phandle" class="headerlink" title="1.1.3、phandle"></a>1.1.3、phandle</h3><ul>
<li>“phandle”属性通用一个唯一的id来标识一个Node，在property可以使用这个id来引用Node。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">phandle</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;u32&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
The phandle property specifies a numerical identifier for a node that is unique within the devicetree. The phandle property value is used by other nodes that need to refer to the node associated with the property.
</td>
</tr>

<tr>
<td> Example: </td>
<td>
See the following devicetree excerpt:<br />
pic@10000000 {<br />
phandle = <1>;<br />
interrupt-controller;<br />
};<br /><br />
A phandle value of 1 is defined. Another device node could reference the pic node with a phandle value of 1:<br />
another-device-node {<br />
interrupt-parent = <1>;<br />
};<br /><br />
Node“pic@10000000”定义了一个phandle属性，这个phandle有唯一id = <1>，在property“interrupt-parent”通过<1>对Node“pic@10000000”进行引用。
</td>
</tr>

</table>

<p>在DeviceTree中通过另一种方式进行phandle的定义和引用更加常见：</p>
<ul>
<li>定义一个“label：”来引用Node，在编译是系统会自动为node生成一个phandle属性。”cpu0”是一个label，用来引用node”cpu@0”：</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">cpu0:</span> <span class="class">cpu@0 </span>&#123;</span><br><span class="line">	device_type = <span class="string">"cpu"</span>;</span><br><span class="line">	compatible = <span class="string">"arm,cortex-a35"</span>;</span><br><span class="line">	reg = <span class="params">&lt;<span class="number">0x000</span>&gt;</span>;</span><br><span class="line">	enable-method = <span class="string">"psci"</span>;</span><br><span class="line">	cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">			  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">	cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">	clock-frequency = <span class="params">&lt;<span class="number">1248000000</span>&gt;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用”&amp;”来引用“label”，即是引用phandle。property”cpu”通过”&amp;cpu0”来对node”cpu@0”：</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cpu-<span class="class">map </span>&#123;</span><br><span class="line">	<span class="class">cluster0 </span>&#123;</span><br><span class="line">		<span class="class">core0 </span>&#123;</span><br><span class="line">			cpu = <span class="params">&lt;<span class="variable">&amp;cpu0</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="class">core1 </span>&#123;</span><br><span class="line">			cpu = <span class="params">&lt;<span class="variable">&amp;cpu1</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="class">core2 </span>&#123;</span><br><span class="line">			cpu = <span class="params">&lt;<span class="variable">&amp;cpu2</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="class">core3 </span>&#123;</span><br><span class="line">			cpu = <span class="params">&lt;<span class="variable">&amp;cpu3</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-4、-address-cells-、-size-cells"><a href="#1-1-4、-address-cells-、-size-cells" class="headerlink" title="1.1.4、#address-cells 、 #size-cells"></a>1.1.4、#address-cells 、 #size-cells</h3><ul>
<li>“#address-cells, #size-cells”属性用来定义当前node的子node中”reg”属性的解析格式。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">#address-cells, #size-cells</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;u32&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
The #address-cells and #size-cells properties may be used in any device node that has children in the devicetree hierarchy and describes how child device nodes should be addressed. The #address-cells property defines the number of &#60;u32&#62; cells used to encode the address field in a child node’s reg property. The #size-cells property defines the number of &#60;u32&#62; cells used to encode the size field in a child node’s reg property.<br />
The #address-cells and #size-cells properties are not inherited from ancestors in the devicetree. They shall be explicitly defined.<br />
A DTSpec-compliant boot program shall supply #address-cells and #size-cells on all nodes that have children.<br />
If missing, a client program should assume a default value of 2 for #address-cells, and a value of 1 for #size-cells.<br />
</td>
</tr>

<tr>
<td> Example: </td>
<td>
See the following devicetree excerpt:<br />
soc {<br />
#address-cells = <1>;<br />
#size-cells = <1>;<br />
&nbsp;&nbsp;&nbsp;&nbsp;serial {<br />
&nbsp;&nbsp;&nbsp;&nbsp;compatible = "ns16550";<br />
&nbsp;&nbsp;&nbsp;&nbsp;reg = <0x4600 0x100>;<br />
&nbsp;&nbsp;&nbsp;&nbsp;clock-frequency = <0>;<br />
&nbsp;&nbsp;&nbsp;&nbsp;interrupts = <0xA 0x8>;<br />
&nbsp;&nbsp;&nbsp;&nbsp;interrupt-parent = <&ipic>;<br />
&nbsp;&nbsp;&nbsp;&nbsp;};<br />
};<br /><br />

In this example, the #address-cells and #size-cells properties of the soc node are both set to 1. This setting specifies that one cell is required to represent an address and one cell is required to represent the size of nodes
that are children of this node.<br />
The serial device reg property necessarily follows this specification set in the parent (soc) node—the address is represented by a single cell (0x4600), and the size is represented by a single cell (0x100).<br />
</td>
</tr>

</table>


<p>举例说明：</p>
<ul>
<li>1、如果node”soc”中”#address-cells=<1>“、”#size-cells=<1>“，那么子node”serial”中”reg”属性的解析为“addr1 = 0x0, size1 = 0x100, addr2 = 0x0, size2 = 0x200”：</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">soc &#123;</span><br><span class="line">    #address-cells = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">    #size-cells = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">    serial &#123;</span><br><span class="line">        reg = &lt;<span class="number">0x0</span> <span class="number">0x100</span> <span class="number">0x0</span> <span class="number">0x200</span>&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>2、如果node”soc”中”#address-cells=<2>“、”#size-cells=<2>“，那么子node”serial”中”reg”属性的解析为“addr1 = 0x100, size1 = 0x200”：</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">soc &#123;</span><br><span class="line">    #address-cells = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">    #size-cells = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">    serial &#123;</span><br><span class="line">        reg = &lt;<span class="number">0x0</span> <span class="number">0x100</span> <span class="number">0x0</span> <span class="number">0x200</span>&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3、如果node”soc”中”#address-cells=<2>“、”#size-cells=<0>“，那么子node”serial”中”reg”属性的解析为“addr1 = 0x100, addr2 = 0x200”：</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">soc &#123;</span><br><span class="line">    #address-cells = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">    #size-cells = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">    serial &#123;</span><br><span class="line">        reg = &lt;<span class="number">0x0</span> <span class="number">0x100</span> <span class="number">0x0</span> <span class="number">0x200</span>&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-5、reg"><a href="#1-1-5、reg" class="headerlink" title="1.1.5、reg"></a>1.1.5、reg</h3><ul>
<li>“reg”属性解析出”address,length”数字，解析格式依据父节点的”#address-cells、#size-cells”定义。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">reg</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;prop-encoded-array&#62; encoded as an arbitrary number of (address, length) pairs. </td>
</tr>

<tr>
<td> Description: </td>
<td>
The reg property describes the address of the device’s resources within the address space defined by its parent bus. Most commonly this means the offsets and lengths of memory-mapped IO register blocks, but may have a different meaning on some bus types. Addresses in the address space defined by the root node are CPU real addresses.<br />
The value is a &#60;prop-encoded-array&#62;, composed of an arbitrary number of pairs of address and length, (address length). The number of &#60;u32&#62; cells required to specify the address and length are bus-specific and are specified by the #address-cells and #size-cells properties in the parent of the device node. If the parent node specifies a value of 0 for #size-cells, the length field in the value of reg shall be omitted.<br />
</td>
</tr>

<tr>
<td> Example: </td>
<td>
Suppose a device within a system-on-a-chip had two blocks of registers, a 32-byte block at offset 0x3000 in the SOC and a 256-byte block at offset 0xFE00. The reg property would be encoded as follows (assuming #address-cells and #size-cells values of 1):<br /><br />
reg = <0x3000 0x20 0xFE00 0x100>;
</td>
</tr>

</table>

<h3 id="1-1-6、ranges"><a href="#1-1-6、ranges" class="headerlink" title="1.1.6、ranges"></a>1.1.6、ranges</h3><ul>
<li>“ranges”属性用来做当前node和父node之间的地址映射，格式为(child-bus-address, parentbus-address, length)。其中child-bus-address的解析长度受当前node的#address-cells属性控制，parentbus-address的解析长度受父node的#address-cells属性控制length的解析长度受当前node的#size-cells属性控制。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">ranges</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;empty&#62; or &#60;prop-encoded-array&#62; encoded as an arbitrary number of (child-bus-address, parentbus-address, length) triplets. </td>
</tr>

<tr>
<td> Description: </td>
<td>
The ranges property provides a means of defining a mapping or translation between the address space of the bus (the child address space) and the address space of the bus node’s parent (the parent address space).<br />
The format of the value of the ranges property is an arbitrary number of triplets of (child-bus-address, parentbus-address, length)<br />
• The child-bus-address is a physical address within the child bus’ address space. The number of cells to represent the address is bus dependent and can be determined from the #address-cells of this node (the node in which the ranges property appears).<br />
• The parent-bus-address is a physical address within the parent bus’ address space. The number of cells to represent the parent address is bus dependent and can be determined from the #address-cells property of the node that defines the parent’s address space.<br />
• The length specifies the size of the range in the child’s address space. The number of cells to represent the size can be determined from the #size-cells of this node (the node in which the ranges property appears).<br />
If the property is defined with an &#60;empty&#62; value, it specifies that the parent and child address space is identical, and no address translation is required.<br />
If the property is not present in a bus node, it is assumed that no mapping exists between children of the node and the parent address space.
</td>
</tr>

<tr>
<td> Example: </td>
<td>
Address Translation Example:<br />
soc {<br />
compatible = "simple-bus";<br />
#address-cells = <1>;<br />
#size-cells = <1>;<br />
ranges = <0x0 0xe0000000 0x00100000>;<br />
serial {<br />
device_type = "serial";<br />
compatible = "ns16550";<br />
reg = <0x4600 0x100>;<br />
clock-frequency = <0>;<br />
interrupts = <0xA 0x8>;<br />
interrupt-parent = <&ipic>;<br />
};<br />
};<br /><br />
The soc node specifies a ranges property of<br />
<0x0 0xe0000000 0x00100000>;<br /><br />
This property value specifies that for an 1024KB range of address space, a child node addressed at physical 0x0 maps to a parent address of physical 0xe0000000. With this mapping, the serial device node can be addressed by a load or store at address 0xe0004600, an offset of 0x4600 (specified in reg) plus the 0xe0000000
mapping specified in ranges.
</td><br />
</tr>

</table>




<h3 id="1-1-7、interrupt-property"><a href="#1-1-7、interrupt-property" class="headerlink" title="1.1.7、interrupt property"></a>1.1.7、interrupt property</h3><p>和中断相关的node可以分成3种：</p>
<ul>
<li>“Interrupt Generating Devices”，中断发生设备，这种设备可以发生中断。</li>
<li>“Interrupt Controllers”，中断控制器，处理中断。</li>
<li>“Interrupt Nexus”，中断联结，路由中断给中断控制器。</li>
</ul>
<p><img src="interrupt_tree.png" alt="image"></p>
<h4 id="1-1-7-1、Interrupt-Generating-Devices-Property"><a href="#1-1-7-1、Interrupt-Generating-Devices-Property" class="headerlink" title="1.1.7.1、Interrupt Generating Devices Property"></a>1.1.7.1、Interrupt Generating Devices Property</h4><ul>
<li>“interrupts”属性用来定义设备的中断解析，根据其”interrupt-parent”node中定义的“#interrupt-cells”来解析。比如#interrupt-cells=2，那根据2个cells为单位来解析”interrupts”属性。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">interrupts</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;prop-encoded-array&#62; encoded as arbitrary number of interrupt specifiers </td>
</tr>

<tr>
<td> Description: </td>
<td>
The interrupts property of a device node defines the interrupt or interrupts that are generated by the device.<br />
The value of the interrupts property consists of an arbitrary number of interrupt specifiers. The format of an interrupt specifier is defined by the binding of the interrupt domain root.<br />
interrupts is overridden by the interrupts-extended property and normally only one or the other should be used.<br />
</td>
</tr>

<tr>
<td> Example: </td>
<td>
A common definition of an interrupt specifier in an open PIC–compatible interrupt domain consists of two cells; an interrupt number and level/sense information. See the following example, which defines a single
interrupt specifier, with an interrupt number of 0xA and level/sense encoding of 8.<br /><br />
interrupts = <0xA 8>;<br />
</td><br />
</tr>

</table>


<ul>
<li>“interrupt-parent”属性用来制定当前设备的Interrupt Controllers/Interrupt Nexus，phandle指向对应的node。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">interrupt-parent</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;phandle&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
Because the hierarchy of the nodes in the interrupt tree might not match the devicetree, the interrupt-parent property is available to make the definition of an interrupt parent explicit. The value is the phandle to the interrupt parent. If this property is missing from a device, its interrupt parent is assumed to be its devicetree parent.<br />
</td>
</tr>

</table>


<h4 id="1-1-7-2、Interrupt-Controllers-Property"><a href="#1-1-7-2、Interrupt-Controllers-Property" class="headerlink" title="1.1.7.2、Interrupt Controllers Property"></a>1.1.7.2、Interrupt Controllers Property</h4><ul>
<li>“#interrupt-cells”属性用来规定连接到该中断控制器上的设备的”interrupts”属性的解析长度。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">#interrupt-cells</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;u32&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
The #interrupt-cells property defines the number of cells required to encode an interrupt specifier for an interrupt domain.<br />
</td>
</tr>

</table>

<ul>
<li>“interrupt-controller”属性用来声明当前node为中断控制器。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">interrupt-controller</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;empty&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
The presence of an interrupt-controller property defines a node as an interrupt controller node.<br />
</td>
</tr>

</table>


<h4 id="1-1-7-3、Interrupt-Nexus-Property"><a href="#1-1-7-3、Interrupt-Nexus-Property" class="headerlink" title="1.1.7.3、Interrupt Nexus Property"></a>1.1.7.3、Interrupt Nexus Property</h4><ul>
<li>“#interrupt-cells”属性用来规定连接到该中断控制器上的设备的”interrupts”属性的解析长度。</li>
</ul>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">#interrupt-cells</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;u32&#62; </td>
</tr>

<tr>
<td> Description: </td>
<td>
The #interrupt-cells property defines the number of cells required to encode an interrupt specifier for an interrupt domain.<br />
</td>
</tr>

</table>


<ul>
<li>“interrupt-map”属性用来描述interrupt nexus设备对中断的路由。解析格式为5元素序列“child unit address, child interrupt specifier, interrupt-parent, parent unit address, parent interrupt specifier”。</li>
</ul>
<p>其中：</p>
<p>“child unit address”的cells长度由子节点的“#address-cells”指定；<br>“child interrupt specifier”的cells长度由子节点的“#interrupt-cells”指定；<br>“interrupt-parent”phandle指向interrupt controller的引用；<br>“parent unit address”的cells长度由父节点的“#address-cells”指定；<br>“parent interrupt specifier”的cells长度由父节点的“#interrupt-cells”指定；</p>
<table border="1">

<tr>
<td style="width: 200px;">Property name:</td>
<td style="width: 600px;">interrupt-map</td>
</tr>

<tr>
<td> Value type: </td>
<td> &#60;prop-encoded-array&#62; encoded as an arbitrary number of interrupt mapping entries. </td>
</tr>

<tr>
<td> Description: </td>
<td>
An interrupt-map is a property on a nexus node that bridges one interrupt domain with a set of parent interrupt domains and specifies how interrupt specifiers in the child domain are mapped to their respective parent
domains.<br />
The interrupt map is a table where each row is a mapping entry consisting of five components: <i>child unit address, child interrupt specifier, interrupt-parent, parent unit address, parent interrupt specifier.</i><br />
<b>child unit address</b> The unit address of the child node being mapped. The number of 32-bit cells required to specify this is described by the #address-cells property of the bus node on which the child is located.<br />
<b>child interrupt specifier</b> The interrupt specifier of the child node being mapped. The number of 32-bit cells required to specify this component is described by the #interrupt-cells property of this node—the nexus node containing the interrupt-map property.<br />
<b>interrupt-parent</b> A single &#60;phandle&#62; value that points to the interrupt parent to which the child domain is being mapped.<br />
<b>parent unit address</b> The unit address in the domain of the interrupt parent. The number of 32-bit cells required to specify this address is described by the #address-cells property of the node pointed to by the interrupt-parent field.<br />
<b>parent interrupt specifier</b> The interrupt specifier in the parent domain. The number of 32-bit cells required to specify this component is described by the #interrupt-cells property of the node pointed to by the interrupt-parent field.<br />
Lookups are performed on the interrupt mapping table by matching a unit-address/interrupt specifier pair against the child components in the interrupt-map. Because some fields in the unit interrupt specifier may not be relevant, a mask is applied before the lookup is done. This mask is defined in the interrupt-map-mask property (see section 2.4.3.2).<br />
</td>
</tr>

</table>

<p>举例：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">soc &#123;</span><br><span class="line">    compatible = <span class="string">"simple-bus"</span>;</span><br><span class="line">    #address-cells = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">    #size-cells = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">    open-pic &#123;</span><br><span class="line">        clock-frequency = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        <span class="built_in">int</span>errupt-controller;</span><br><span class="line">        #address-cells = &lt;<span class="number">0</span>&gt;;</span><br><span class="line">        #<span class="built_in">int</span>errupt-cells = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">    pci &#123;</span><br><span class="line">        #<span class="built_in">int</span>errupt-cells = &lt;<span class="number">1</span>&gt;;</span><br><span class="line">        #size-cells = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">        #address-cells = &lt;<span class="number">3</span>&gt;;</span><br><span class="line">        <span class="built_in">int</span>errupt-map-mask = &lt;<span class="number">0xf800</span> <span class="number">0</span> <span class="number">0</span> <span class="number">7</span>&gt;;</span><br><span class="line">        <span class="built_in">int</span>errupt-map = &lt;</span><br><span class="line">        <span class="comment">/* IDSEL 0x11 - PCI slot 1 */</span></span><br><span class="line">        <span class="number">0x8800</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> &amp;open-pic <span class="number">2</span> <span class="number">1</span> <span class="comment">/* INTA */</span></span><br><span class="line">        <span class="number">0x8800</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> &amp;open-pic <span class="number">3</span> <span class="number">1</span> <span class="comment">/* INTB */</span></span><br><span class="line">        <span class="number">0x8800</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3</span> &amp;open-pic <span class="number">4</span> <span class="number">1</span> <span class="comment">/* INTC */</span></span><br><span class="line">        <span class="number">0x8800</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4</span> &amp;open-pic <span class="number">1</span> <span class="number">1</span> <span class="comment">/* INTD */</span></span><br><span class="line">        <span class="comment">/* IDSEL 0x12 - PCI slot 2 */</span></span><br><span class="line">        <span class="number">0x9000</span> <span class="number">0</span> <span class="number">0</span> <span class="number">1</span> &amp;open-pic <span class="number">3</span> <span class="number">1</span> <span class="comment">/* INTA */</span></span><br><span class="line">        <span class="number">0x9000</span> <span class="number">0</span> <span class="number">0</span> <span class="number">2</span> &amp;open-pic <span class="number">4</span> <span class="number">1</span> <span class="comment">/* INTB */</span></span><br><span class="line">        <span class="number">0x9000</span> <span class="number">0</span> <span class="number">0</span> <span class="number">3</span> &amp;open-pic <span class="number">1</span> <span class="number">1</span> <span class="comment">/* INTC */</span></span><br><span class="line">        <span class="number">0x9000</span> <span class="number">0</span> <span class="number">0</span> <span class="number">4</span> &amp;open-pic <span class="number">2</span> <span class="number">1</span> <span class="comment">/* INTD */</span></span><br><span class="line">        &gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">•</span> <span class="string">For</span> <span class="string">example,</span> <span class="string">the</span> <span class="string">first</span> <span class="string">row</span> <span class="string">of</span> <span class="string">the</span> <span class="string">interrupt-map</span> <span class="string">table</span> <span class="string">specifies</span> <span class="string">the</span> <span class="string">mapping</span> <span class="string">for</span> <span class="string">INTA</span> <span class="string">of</span> <span class="string">slot</span> <span class="number">1</span><span class="string">.</span> <span class="string">The</span> <span class="string">components</span> <span class="string">of</span> <span class="string">that</span> <span class="string">row</span> <span class="string">are</span> <span class="string">shown</span> <span class="string">here</span></span><br><span class="line">    <span class="attr">child unit address:</span> <span class="number">0x8800</span> <span class="number">0</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">child interrupt specifier:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">interrupt parent:</span> <span class="string">&amp;open-pic</span></span><br><span class="line">    <span class="attr">parent unit address:</span> <span class="string">(empty</span> <span class="string">because</span> <span class="comment">#address-cells = &lt;0&gt; in the open-pic node)</span></span><br><span class="line">    <span class="attr">parent interrupt specifier:</span> <span class="number">2</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="1-2、标准Node"><a href="#1-2、标准Node" class="headerlink" title="1.2、标准Node"></a>1.2、标准Node</h2><p>Node Name常常由两部分组成“node-name@unit-address”，主要是为了防止Node Name重复冲突：</p>
<ul>
<li>“node-name”是node的名字；</li>
<li>“unit-address”是node中“reg”属性描述的开始地址；</li>
</ul>
<p>例如：”msdc@11240000”中node-name=“msdc”，unit-address=“11240000”。</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">/ &#123;</span></span><br><span class="line"><span class="class">	model = <span class="string">"mt6799"</span>;</span></span><br><span class="line"><span class="class">	compatible = <span class="string">"mediatek,mt6799"</span>;</span></span><br><span class="line"><span class="class">	interrupt-parent = <span class="params">&lt;<span class="variable">&amp;gic</span>&gt;</span>;</span></span><br><span class="line"><span class="class">	#address-cells = <span class="params">&lt;<span class="number">2</span>&gt;</span>;</span></span><br><span class="line"><span class="class">	#size-cells = <span class="params">&lt;<span class="number">2</span>&gt;</span>;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="symbol">	msdc0:</span><span class="class">msdc@11240000 </span>&#123;</span></span><br><span class="line"><span class="class">		compatible = <span class="string">"mediatek,msdc"</span>;</span></span><br><span class="line"><span class="class">		reg = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x11240000</span> <span class="number">0x0</span> <span class="number">0x10000</span></span></span></span><br><span class="line"><span class="class"><span class="params">		       <span class="number">0x0</span> <span class="number">0x10000e84</span> <span class="number">0x0</span> <span class="number">0x2</span>&gt;</span>;    <span class="comment">/* FPGA PWR_GPIO, PWR_GPIO_EO */</span></span></span><br><span class="line"><span class="class">		interrupts = <span class="params">&lt;GIC_SPI <span class="number">79</span> IRQ_TYPE_LEVEL_LOW&gt;</span>;</span></span><br><span class="line"><span class="class">	&#125;;</span></span><br></pre></td></tr></table></figure>
<p>下面主要介绍一下一些预先定义的标准Node。</p>
<h3 id="1-2-1、Root-node"><a href="#1-2-1、Root-node" class="headerlink" title="1.2.1、Root node"></a>1.2.1、Root node</h3><p>每个DeviceTree只有一个根节点。根节点需要有以下必备属性：</p>
<table border="1">
<caption>  Root Node Properties </caption>

<tr>
<th style="width: 150px;">Property Name</th>
<th style="width: 100px;">Usage</th>
<th style="width: 150px;">Value Type</th>
<th style="width: 600px;">Definition</th>
</tr>

<tr>
<td> #address-cells </td>
<td> R </td>
<td> &#60;u32&#62; </td>
<td> 
Specifies the number of &#60;u32&#62; cells to represent the address in the reg  property in children of root. 
</td>
</tr>

<tr>
<td> #size-cells </td>
<td> R </td>
<td> &#60;u32&#62; </td>
<td> 
Specifies the number of &#60;u32&#62; cells to represent the size in the reg property in children of root. 
</td>
</tr>

<tr>
<td> model </td>
<td> R </td>
<td> &#60;string&#62; </td>
<td> 
Specifies a string that uniquely identifies the model of the system board. The recommended format is “manufacturer,model-number”.
</td>
</tr>

<tr>
<td> compatible </td>
<td> R </td>
<td> &#60;stringlist&#62; </td>
<td> 
Specifies a list of platform architectures with which this platform is compatible. This property can be used by operating systems in selecting
platform specific code. The recommended form of the property value is:<br />
"manufacturer,model"<br /><br />
For example:<br />
compatible = "fsl,mpc8572ds"<br />
</td>
</tr>

</table>

<h3 id="1-2-2、-aliases-node"><a href="#1-2-2、-aliases-node" class="headerlink" title="1.2.2、/aliases node"></a>1.2.2、/aliases node</h3><p>用来给一些绝对路径定义别名：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">aliases &#123;</span><br><span class="line">    serial<span class="number">0</span> = <span class="string">"/simple-bus@fe000000/serial@llc500"</span>;</span><br><span class="line">    ethernet<span class="number">0</span> = <span class="string">"/simple-bus@fe000000/ethernet@31c000"</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-3、-memory-node"><a href="#1-2-3、-memory-node" class="headerlink" title="1.2.3、/memory node"></a>1.2.3、/memory node</h3><p>用来传递内存布局：</p>
<table border="1">
<caption>  /memory Node Properties </caption>

<tr>
<th style="width: 150px;">Property Name</th>
<th style="width: 100px;">Usage</th>
<th style="width: 150px;">Value Type</th>
<th style="width: 600px;">Definition</th>
</tr>

<tr>
<td> device_type </td>
<td> R </td>
<td> &#60;string&#62; </td>
<td> 
Value shall be “memory”
</td>
</tr>

<tr>
<td> reg </td>
<td> R </td>
<td> &#60;prop-encoded-array&#62; </td>
<td> 
Consists of an arbitrary number of address and size pairs that specify the physical address and size of the memory ranges.
</td>
</tr>

<tr>
<td> initial-mapped-area </td>
<td> O </td>
<td> &#60;prop-encoded-array&#62; </td>
<td> 
Specifies the address and size of the Initial Mapped Area
Is a prop-encoded-array consisting of a triplet of (effective address, physical address, size).
The effective and physical address shall each be 64-bit (&#60;u64&#62; value), and the size shall be 32-bits (&#60;u32&#62; value).
</td>
</tr>

</table>

<p>举例：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">• RAM: starting<span class="built_in"> address </span>0x0, length 0x80000000 (2GB)</span><br><span class="line">• RAM: starting<span class="built_in"> address </span>0x100000000, length 0x100000000 (4GB)</span><br></pre></td></tr></table></figure></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">\ &#123;</span><br><span class="line">    #address-cells = &lt;<span class="number">2</span>&gt;;</span><br><span class="line">    #size-cells = &lt;<span class="number">2</span>&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="symbol">memory@</span><span class="number">0</span> &#123;</span><br><span class="line">        device_type = <span class="string">"memory"</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x000000000</span> <span class="number">0x00000000</span> <span class="number">0x00000000</span> <span class="number">0x80000000</span></span><br><span class="line">        <span class="number">0x000000001</span> <span class="number">0x00000000</span> <span class="number">0x00000001</span> <span class="number">0x00000000</span>&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-2-4、-chosen-node"><a href="#1-2-4、-chosen-node" class="headerlink" title="1.2.4、/chosen node"></a>1.2.4、/chosen node</h3><p>其中“bootargs”属性用来传递cmdline参数，“stdout-path”属性用来指定标准输出设备，“stdin-path”属性用来指定标准输入设备。</p>
<table border="1">
<caption>  /chosen Node Properties </caption>

<tr>
<th style="width: 150px;">Property Name</th>
<th style="width: 100px;">Usage</th>
<th style="width: 150px;">Value Type</th>
<th style="width: 600px;">Definition</th>
</tr>

<tr>
<td> bootargs </td>
<td> O </td>
<td> &#60;string&#62; </td>
<td> 
A string that specifies the boot arguments for the client program. The value could potentially be a null string if no boot arguments are required.
</td>
</tr>

<tr>
<td> stdout-path </td>
<td> O </td>
<td> &#60;string&#62; </td>
<td> 
A string that specifies the full path to the node representing the device to be used for boot console output. If the character “:” is present in the value it terminates the path. The value may be an alias. If the stdin-path property is
not specified, stdout-path should be assumed to define the input device.
</td>
</tr>

<tr>
<td> stdin-path </td>
<td> O </td>
<td> &#60;string&#62; </td>
<td> 
A string that specifies the full path to the node representing the device to be used for boot console input. If the character “:” is present in the value it terminates the path. The value may be an alias.
</td>
</tr>

</table>

<p>举例：</p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* chosen */</span><br><span class="line">chosen &#123;</span><br><span class="line">	bootargs = <span class="string">"console=tty0 console=ttyMT0,921600n1 root=/dev/ram"</span><span class="comment">;</span></span><br><span class="line">&#125;<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h3 id="1-2-5、-cpus-node"><a href="#1-2-5、-cpus-node" class="headerlink" title="1.2.5、/cpus node"></a>1.2.5、/cpus node</h3><p>/cpus节点也是必须的，下面举个具体例子：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="class">cpus </span>&#123;</span><br><span class="line">	<span class="meta">#address-cells = &lt;1&gt;;</span></span><br><span class="line">	<span class="meta">#size-cells = &lt;0&gt;;</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu0:</span> <span class="class">cpu@0 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a35"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x000</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1248000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu1:</span> <span class="class">cpu@001 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a35"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x001</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1248000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu2:</span> <span class="class">cpu@002 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a35"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x002</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1248000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu3:</span> <span class="class">cpu@003 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a35"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x003</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1248000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu4:</span> <span class="class">cpu@100 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a53"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x100</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1378000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu5:</span> <span class="class">cpu@101 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a53"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x101</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1378000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu6:</span> <span class="class">cpu@102 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a53"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x102</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1378000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu7:</span> <span class="class">cpu@103 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a53"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x103</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1378000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu8:</span> <span class="class">cpu@200 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a73"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x200</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1638000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">	cpu9:</span> <span class="class">cpu@201 </span>&#123;</span><br><span class="line">		device_type = <span class="string">"cpu"</span>;</span><br><span class="line">		compatible = <span class="string">"arm,cortex-a73"</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x201</span>&gt;</span>;</span><br><span class="line">		enable-method = <span class="string">"psci"</span>;</span><br><span class="line">		cpu-idle-states = <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_MCDI <span class="variable">&amp;</span>LEGACY_SODI <span class="variable">&amp;</span>LEGACY_SODI3 <span class="variable">&amp;</span>LEGACY_DPIDLE&gt;</span>,</span><br><span class="line">				  <span class="params">&lt;<span class="variable">&amp;</span>LEGACY_SUSPEND <span class="variable">&amp;</span>MCDI <span class="variable">&amp;</span>SODI <span class="variable">&amp;</span>SODI3 <span class="variable">&amp;</span>DPIDLE <span class="variable">&amp;</span>SUSPEND&gt;</span>;</span><br><span class="line">		cpu-release-addr = <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x40000200</span>&gt;</span>;</span><br><span class="line">		clock-frequency = <span class="params">&lt;<span class="number">1638000000</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	cpu-<span class="class">map </span>&#123;</span><br><span class="line">		<span class="class">cluster0 </span>&#123;</span><br><span class="line">			<span class="class">core0 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu0</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">			<span class="class">core1 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu1</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="class">core2 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu2</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="class">core3 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu3</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="class">cluster1 </span>&#123;</span><br><span class="line">			<span class="class">core0 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu4</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="class">core1 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu5</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="class">core2 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu6</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="class">core3 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu7</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="class">cluster2 </span>&#123;</span><br><span class="line">			<span class="class">core0 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu8</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">			<span class="class">core1 </span>&#123;</span><br><span class="line">				cpu = <span class="params">&lt;<span class="variable">&amp;cpu9</span>&gt;</span>;</span><br><span class="line">			&#125;;</span><br><span class="line"></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	idle-<span class="class">states </span>&#123;</span><br><span class="line">		entry-method = <span class="string">"arm,psci"</span>;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		LEGACY_MCDI:</span> legacy-<span class="class">mcdi </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x0000001</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">1200</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		LEGACY_SODI:</span> legacy-<span class="class">sodi </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x0000002</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">1200</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		LEGACY_SODI3:</span> legacy-<span class="class">sodi3 </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x0000003</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">1200</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		LEGACY_DPIDLE:</span> legacy-<span class="class">dpidle </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x0000004</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">1200</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		LEGACY_SUSPEND:</span> legacy-<span class="class">suspend </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x0000005</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">1200</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		MCDI:</span> <span class="class">mcdi </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x0010001</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">600</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">1200</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		SODI:</span> <span class="class">sodi </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x1010002</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">800</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">1000</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">2000</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		SODI3:</span> <span class="class">sodi3 </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x1010003</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">800</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">1000</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">2000</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		DPIDLE:</span> <span class="class">dpidle </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x1010004</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">800</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">1000</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">2000</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line"><span class="symbol">		SUSPEND:</span> <span class="class">suspend </span>&#123;</span><br><span class="line">			compatible = <span class="string">"arm,idle-state"</span>;</span><br><span class="line">			arm,psci-suspend-param = <span class="params">&lt;<span class="number">0x1010005</span>&gt;</span>;</span><br><span class="line">			entry-latency-us = <span class="params">&lt;<span class="number">800</span>&gt;</span>;</span><br><span class="line">			exit-latency-us = <span class="params">&lt;<span class="number">1000</span>&gt;</span>;</span><br><span class="line">			min-residency-us = <span class="params">&lt;<span class="number">2000</span>&gt;</span>;</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h1 id="2、DTB"><a href="#2、DTB" class="headerlink" title="2、DTB"></a>2、DTB</h1><h2 id="2-1、DTB的编译"><a href="#2-1、DTB的编译" class="headerlink" title="2.1、DTB的编译"></a>2.1、DTB的编译</h2><p>DTB(Devicetree Blob)是DTS的二进制文件格式，Kernel使用DTC工具将DTS源文件编译成DTB，bootloader再将DTB文件传递给Kernel解析。</p>
<p>不遵守标准书写的DTS文件在编译的时候会报错。</p>
<h2 id="2-2、DTB的文件结构"><a href="#2-2、DTB的文件结构" class="headerlink" title="2.2、DTB的文件结构"></a>2.2、DTB的文件结构</h2><p><img src="dtb_struct.png" alt="image"></p>
<p>DTB文件的结构如上图所示，主要在3部分：</p>
<ul>
<li>struct ftd_header。文件头结构；</li>
<li>structure block。存放含Node和Property的Value；</li>
<li>strings block。存放Property的Name；把Property Name单独分为一个区域的原因是，有很多Property Name是重复的，单独一个区域可以使用指针引用，节约空间。</li>
</ul>
<p>dtb中的fdt_header的数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdt_header</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> magic;</span><br><span class="line">    <span class="keyword">uint32_t</span> totalsize;</span><br><span class="line">    <span class="keyword">uint32_t</span> off_dt_struct;</span><br><span class="line">    <span class="keyword">uint32_t</span> off_dt_strings;</span><br><span class="line">    <span class="keyword">uint32_t</span> off_mem_rsvmap;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line">    <span class="keyword">uint32_t</span> last_comp_version;</span><br><span class="line">    <span class="keyword">uint32_t</span> boot_cpuid_phys;</span><br><span class="line">    <span class="keyword">uint32_t</span> size_dt_strings;</span><br><span class="line">    <span class="keyword">uint32_t</span> size_dt_struct;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>dtb中node header的数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdt_node_header</span> &#123;</span></span><br><span class="line">	<span class="keyword">fdt32_t</span> tag;</span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">0</span>];   <span class="comment">// node name 存放在structure block</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>dtb中property header的数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdt_property</span> &#123;</span></span><br><span class="line">	<span class="keyword">fdt32_t</span> tag;</span><br><span class="line">	<span class="keyword">fdt32_t</span> len;</span><br><span class="line">	<span class="keyword">fdt32_t</span> nameoff;    <span class="comment">// perperty name存放在strings block</span></span><br><span class="line">	<span class="keyword">char</span> data[<span class="number">0</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>整个文件使用5种token来分割出node和property：</p>
<ul>
<li>FDT_BEGIN_NODE (0x00000001)</li>
<li>FDT_END_NODE (0x00000002)</li>
<li>FDT_PROP (0x00000003)</li>
<li>FDT_NOP (0x00000004)</li>
<li>FDT_END (0x00000009)</li>
</ul>
<p>可以使用hex编辑器来查看DTB文件的结构：</p>
<p><img src="dtb_hex_example.png" alt="image"></p>
<h2 id="2-3、Bootloader对DTB的传递"><a href="#2-3、Bootloader对DTB的传递" class="headerlink" title="2.3、Bootloader对DTB的传递"></a>2.3、Bootloader对DTB的传递</h2><p>没有仔细去看</p>
<h1 id="3、Kernel解析"><a href="#3、Kernel解析" class="headerlink" title="3、Kernel解析"></a>3、Kernel解析</h1><h2 id="3-1、DTB解析"><a href="#3-1、DTB解析" class="headerlink" title="3.1、DTB解析"></a>3.1、DTB解析</h2><h3 id="3-1-1-setup-machine-fdt"><a href="#3-1-1-setup-machine-fdt" class="headerlink" title="3.1.1 setup_machine_fdt()"></a>3.1.1 setup_machine_fdt()</h3><p>直接在dtb中解析根节点的一些属性和子节点给系统早期使用。</p>
<ul>
<li>解析”/“节点的model”属性给machine_desc赋值；</li>
<li>解析”/chosen”node中的”bootargs”属性给boot_command_line；</li>
<li>解析”/“节点的”#size-cells”、”#address-cells”属性；</li>
<li>解析”/memory”node中的”reg”属性，并将memory区域加入到系统；</li>
</ul>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">start_kernel<span class="function"><span class="params">()</span> -&gt;</span> setup_arch<span class="function"><span class="params">()</span> -&gt;</span> setup_machine_fdt():</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line">static <span class="literal">void</span> __init setup_machine_fdt(phys_addr_t dt_phys)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* (1) 映射dtb内存，到使之可以访问 */</span></span><br><span class="line">	<span class="literal">void</span> *dt_virt = fixmap_remap_fdt(dt_phys);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2) 早期扫描device tree中的一些node和property */</span></span><br><span class="line">	<span class="keyword">if</span> (!dt_virt || !early_init_dt_scan(dt_virt)) &#123;</span><br><span class="line">		pr_crit(<span class="string">"\n"</span></span><br><span class="line">			<span class="string">"Error: invalid device tree blob at physical address %pa (virtual address 0x%p)\n"</span></span><br><span class="line">			<span class="string">"The dtb must be 8-byte aligned and must not exceed 2 MB in size\n"</span></span><br><span class="line">			<span class="string">"\nPlease check your bootloader."</span>,</span><br><span class="line">			&amp;dt_phys, dt_virt);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">			cpu_relax();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (3) 使用device tree中root node的"model/compatible"属性给machine_desc赋值 */</span></span><br><span class="line">	machine_desc_set(of_flat_dt_get_machine_name());</span><br><span class="line">	dump_stack_set_arch_desc(<span class="string">"%s (DT)"</span>, of_flat_dt_get_machine_name());</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line">bool __init early_init_dt_scan(<span class="literal">void</span> *params)</span><br><span class="line">&#123;</span><br><span class="line">	bool status;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.1)校验dtb数据 */</span></span><br><span class="line">	status = early_init_dt_verify(params);</span><br><span class="line">	<span class="keyword">if</span> (!status)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2) */</span></span><br><span class="line">	early_init_dt_scan_nodes();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="literal">void</span> __init early_init_dt_scan_nodes(<span class="literal">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* (2.2.1) 解析"/chosen"node中的"bootargs"属性 */</span></span><br><span class="line">	<span class="comment">/* Retrieve various information from the /chosen node */</span></span><br><span class="line">	of_scan_flat_dt(early_init_dt_scan_chosen, boot_command_line);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.2) 解析"/"node中的"#size-cells"、"#address-cells"属性 */</span></span><br><span class="line">	<span class="comment">/* Initialize &#123;size,address&#125;-cells info */</span></span><br><span class="line">	of_scan_flat_dt(early_init_dt_scan_root, NULL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.3) 解析"/memory"node中的"reg"属性，并将memory区域加入到系统 */</span></span><br><span class="line">	<span class="comment">/* Setup memory, calling early_init_dt_add_memory_arch */</span></span><br><span class="line">	of_scan_flat_dt(early_init_dt_scan_memory, NULL);</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line">early_init_dt_scan_memory<span class="function"><span class="params">()</span> -&gt;</span> early_init_dt_add_memory_arch<span class="function"><span class="params">()</span> -&gt;</span> memblock_add()</span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-unflatten-device-tree"><a href="#3-1-2-unflatten-device-tree" class="headerlink" title="3.1.2 unflatten_device_tree()"></a>3.1.2 unflatten_device_tree()</h3><p>将DTB完全解析为内核使用的的device_node、property结构：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br></pre></td><td class="code"><pre><span class="line">start_kernel() -&gt; setup_arch() -&gt; unflatten_device_tree():</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> __init <span class="title">unflatten_device_tree</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* (1) 解析dtb数据到kernel中 */</span></span><br><span class="line">	__unflatten_device_tree(initial_boot_params, &amp;of_root,</span><br><span class="line">				early_init_dt_alloc_memory_arch);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2) 扫描"/aliases"、"/chosen"节点来进行一些预制值的配置 */</span></span><br><span class="line">	<span class="comment">/* Get pointer to "/chosen" and "/aliases" nodes for use everywhere */</span></span><br><span class="line">	of_alias_scan(early_init_dt_alloc_memory_arch);</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __unflatten_device_tree(<span class="keyword">const</span> <span class="keyword">void</span> *blob,</span><br><span class="line">			     struct device_node **mynodes,</span><br><span class="line">			     <span class="keyword">void</span> * (*dt_alloc)(u64 <span class="built_in">size</span>, u64 align))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="built_in">size</span>;</span><br><span class="line">	<span class="keyword">int</span> start;</span><br><span class="line">	<span class="keyword">void</span> *mem;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">" -&gt; unflatten_device_tree()\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!blob) &#123;</span><br><span class="line">		pr_debug(<span class="string">"No device tree pointer\n"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">"Unflattening device tree:\n"</span>);</span><br><span class="line">	pr_debug(<span class="string">"magic: %08x\n"</span>, fdt_magic(blob));</span><br><span class="line">	pr_debug(<span class="string">"size: %08x\n"</span>, fdt_totalsize(blob));</span><br><span class="line">	pr_debug(<span class="string">"version: %08x\n"</span>, fdt_version(blob));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fdt_check_header(blob)) &#123;</span><br><span class="line">		pr_err(<span class="string">"Invalid device tree blob header\n"</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (1.1) 第一遍扫描，计算dtb解析需要的内存空间 */</span></span><br><span class="line">	<span class="comment">/* First pass, scan for size */</span></span><br><span class="line">	start = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">size</span> = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)unflatten_dt_node(blob, <span class="literal">NULL</span>, &amp;start, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">	<span class="built_in">size</span> = ALIGN(<span class="built_in">size</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">"  size is %lx, allocating...\n"</span>, <span class="built_in">size</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (1.2) 分配所需内存 */</span></span><br><span class="line">	<span class="comment">/* Allocate memory for the expanded device tree */</span></span><br><span class="line">	mem = dt_alloc(<span class="built_in">size</span> + <span class="number">4</span>, __alignof__(struct device_node));</span><br><span class="line">	<span class="built_in">memset</span>(mem, <span class="number">0</span>, <span class="built_in">size</span>);</span><br><span class="line"></span><br><span class="line">	*(__be32 *)(mem + <span class="built_in">size</span>) = cpu_to_be32(<span class="number">0xdeadbeef</span>);</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">"  unflattening %p...\n"</span>, mem);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (1.3)第二遍扫描，在分配的内存中创建device_node、property树形结构来存储dtb的解析 */</span></span><br><span class="line">	<span class="comment">/* Second pass, do actual unflattening */</span></span><br><span class="line">	start = <span class="number">0</span>;</span><br><span class="line">	unflatten_dt_node(blob, mem, &amp;start, <span class="literal">NULL</span>, mynodes, <span class="number">0</span>, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">if</span> (be32_to_cpup(mem + <span class="built_in">size</span>) != <span class="number">0xdeadbeef</span>)</span><br><span class="line">		pr_warning(<span class="string">"End of tree marker overwritten: %08x\n"</span>,</span><br><span class="line">			   be32_to_cpup(mem + <span class="built_in">size</span>));</span><br><span class="line"></span><br><span class="line">	pr_debug(<span class="string">" &lt;- unflatten_device_tree()\n"</span>);</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">unflatten_dt_node</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *blob,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">void</span> *mem,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">int</span> *poffset,</span></span></span><br><span class="line"><span class="function"><span class="params">				struct device_node *dad,</span></span></span><br><span class="line"><span class="function"><span class="params">				struct device_node **nodepp,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">unsigned</span> <span class="keyword">long</span> fpsize,</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">bool</span> dryrun)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">const</span> __be32 *p;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">property</span> *<span class="title">pp</span>, **<span class="title">prev_pp</span> = <span class="title">NULL</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *pathp;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> l, allocl;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> depth;</span><br><span class="line">	<span class="keyword">int</span> old_depth;</span><br><span class="line">	<span class="keyword">int</span> offset;</span><br><span class="line">	<span class="keyword">int</span> has_name = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> new_format = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (1.1.1) 解析node，解析node中的name值 */</span></span><br><span class="line">	pathp = fdt_get_name(blob, *poffset, &amp;l);</span><br><span class="line">	<span class="keyword">if</span> (!pathp)</span><br><span class="line">		<span class="keyword">return</span> mem;</span><br><span class="line"></span><br><span class="line">	allocl = ++l;	<span class="comment">/* l 为当前路径的长度 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* version 0x10 has a more compact unit name here instead of the full</span></span><br><span class="line"><span class="comment">	 * path. we accumulate the full path size using "fpsize", we'll rebuild</span></span><br><span class="line"><span class="comment">	 * it later. We detect this because the first character of the name is</span></span><br><span class="line"><span class="comment">	 * not '/'.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> ((*pathp) != <span class="string">'/'</span>) &#123;</span><br><span class="line">		new_format = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (fpsize == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="comment">/* root node: special case. fpsize accounts for path</span></span><br><span class="line"><span class="comment">			 * plus terminating zero. root node only has '/', so</span></span><br><span class="line"><span class="comment">			 * fpsize should be 2, but we want to avoid the first</span></span><br><span class="line"><span class="comment">			 * level nodes to have two '/' so we use fpsize 1 here</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			fpsize = <span class="number">1</span>;</span><br><span class="line">			allocl = <span class="number">2</span>;</span><br><span class="line">			l = <span class="number">1</span>;</span><br><span class="line">			pathp = <span class="string">""</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">/* account for '/' and path size minus terminal 0</span></span><br><span class="line"><span class="comment">			 * already in 'l'</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			fpsize += l;	<span class="comment">/* 当前full path的长度 = 上一次full path的长度 + 当前node nam的长度 l */</span></span><br><span class="line">			allocl = fpsize;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 计算解析当前node节点需要的内存大小 = device_node + full path  */</span></span><br><span class="line">	np = unflatten_dt_alloc(&amp;mem, <span class="keyword">sizeof</span>(struct device_node) + allocl,</span><br><span class="line">				__alignof__(struct device_node));</span><br><span class="line">    <span class="comment">/*  dryrun = true，只进行长度计算</span></span><br><span class="line"><span class="comment">     dryrun = fasle，进行实际的赋值  */</span></span><br><span class="line">	<span class="keyword">if</span> (!dryrun) &#123;</span><br><span class="line">		<span class="keyword">char</span> *fn;</span><br><span class="line">		of_node_init(np);</span><br><span class="line">		np-&gt;full_name = fn = ((<span class="keyword">char</span> *)np) + <span class="keyword">sizeof</span>(*np);	 <span class="comment">/* device_node-&gt;full_name，指向device_node结构体的结尾 */</span> </span><br><span class="line">		<span class="keyword">if</span> (new_format) &#123;</span><br><span class="line">			<span class="comment">/* rebuild full path for new format */</span></span><br><span class="line">			<span class="keyword">if</span> (dad &amp;&amp; dad-&gt;parent) &#123;</span><br><span class="line">                 <span class="comment">/* 先拷入上次的full name */</span></span><br><span class="line">				<span class="built_in">strcpy</span>(fn, dad-&gt;full_name);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">				<span class="keyword">if</span> ((<span class="built_in">strlen</span>(fn) + l + <span class="number">1</span>) != allocl) &#123;</span><br><span class="line">					pr_debug(<span class="string">"%s: p: %d, l: %d, a: %d\n"</span>,</span><br><span class="line">						pathp, (<span class="keyword">int</span>)<span class="built_in">strlen</span>(fn),</span><br><span class="line">						l, allocl);</span><br><span class="line">				&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">				fn += <span class="built_in">strlen</span>(fn);</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">/* 再加上 '/' */</span></span><br><span class="line">			*(fn++) = <span class="string">'/'</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">/* 最后加上当前node的name */</span></span><br><span class="line">		<span class="built_in">memcpy</span>(fn, pathp, l);</span><br><span class="line"></span><br><span class="line">		prev_pp = &amp;np-&gt;properties;</span><br><span class="line">        <span class="comment">/* node和node之间树形结构的创建 */</span></span><br><span class="line">		<span class="keyword">if</span> (dad != <span class="literal">NULL</span>) &#123;	</span><br><span class="line">			np-&gt;parent = dad;</span><br><span class="line">			np-&gt;sibling = dad-&gt;child;</span><br><span class="line">			dad-&gt;child = np;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (1.1.2) 解析node中的property */</span></span><br><span class="line">	<span class="comment">/* process properties */</span></span><br><span class="line">	<span class="keyword">for</span> (offset = fdt_first_property_offset(blob, *poffset);</span><br><span class="line">	     (offset &gt;= <span class="number">0</span>);</span><br><span class="line">	     (offset = fdt_next_property_offset(blob, offset))) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *pname;</span><br><span class="line">		u32 sz;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 解析一个property：</span></span><br><span class="line"><span class="comment">          p：property中的data</span></span><br><span class="line"><span class="comment">          pname：property的name指针，实际存储位置在dt_strings区域中</span></span><br><span class="line"><span class="comment">         sz：property data的长度</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">		<span class="keyword">if</span> (!(p = fdt_getprop_by_offset(blob, offset, &amp;pname, &amp;sz))) &#123;</span><br><span class="line">			offset = -FDT_ERR_INTERNAL;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pname == <span class="literal">NULL</span>) &#123;</span><br><span class="line">			pr_info(<span class="string">"Can't find property name in list !\n"</span>);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(pname, <span class="string">"name"</span>) == <span class="number">0</span>)</span><br><span class="line">			has_name = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">/* 计算解析当前property的内存大小 = property */</span></span><br><span class="line">		pp = unflatten_dt_alloc(&amp;mem, <span class="keyword">sizeof</span>(struct property),</span><br><span class="line">					__alignof__(struct property));</span><br><span class="line">        <span class="comment">/* 实际的property赋值 */</span></span><br><span class="line">		<span class="keyword">if</span> (!dryrun) &#123;</span><br><span class="line">			<span class="comment">/* We accept flattened tree phandles either in</span></span><br><span class="line"><span class="comment">			 * ePAPR-style "phandle" properties, or the</span></span><br><span class="line"><span class="comment">			 * legacy "linux,phandle" properties.  If both</span></span><br><span class="line"><span class="comment">			 * appear and have different values, things</span></span><br><span class="line"><span class="comment">			 * will get weird.  Don't do that. */</span></span><br><span class="line">            <span class="comment">/* 如果property为"phandle"，设置父node的device_node-&gt;phandle为当前属性的值 */</span></span><br><span class="line">			<span class="keyword">if</span> ((<span class="built_in">strcmp</span>(pname, <span class="string">"phandle"</span>) == <span class="number">0</span>) ||</span><br><span class="line">			    (<span class="built_in">strcmp</span>(pname, <span class="string">"linux,phandle"</span>) == <span class="number">0</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (np-&gt;phandle == <span class="number">0</span>)</span><br><span class="line">					np-&gt;phandle = be32_to_cpup(p);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">/* And we process the "ibm,phandle" property</span></span><br><span class="line"><span class="comment">			 * used in pSeries dynamic device tree</span></span><br><span class="line"><span class="comment">			 * stuff */</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">strcmp</span>(pname, <span class="string">"ibm,phandle"</span>) == <span class="number">0</span>)</span><br><span class="line">				np-&gt;phandle = be32_to_cpup(p);</span><br><span class="line">            <span class="comment">/* 给property的其他字段赋值：（DTB的空间没有释放，被property成员指针引用）</span></span><br><span class="line"><span class="comment">            property-&gt;name：指针指向dtb strings blcok区域中的属性name</span></span><br><span class="line"><span class="comment">            property-&gt;length：属性data的长度</span></span><br><span class="line"><span class="comment">            property-&gt;value：指针指向dtb stucture block区域中的属性data</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">			pp-&gt;name = (<span class="keyword">char</span> *)pname;</span><br><span class="line">			pp-&gt;length = sz;</span><br><span class="line">			pp-&gt;value = (__be32 *)p;</span><br><span class="line">			*prev_pp = pp;</span><br><span class="line">			prev_pp = &amp;pp-&gt;next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">/* with version 0x10 we may not have the name property, recreate</span></span><br><span class="line"><span class="comment">	 * it here from the unit name if absent</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!has_name) &#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *p1 = pathp, *ps = pathp, *pa = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">int</span> sz;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (*p1) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((*p1) == <span class="string">'@'</span>)</span><br><span class="line">				pa = p1;</span><br><span class="line">			<span class="keyword">if</span> ((*p1) == <span class="string">'/'</span>)</span><br><span class="line">				ps = p1 + <span class="number">1</span>;</span><br><span class="line">			p1++;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (pa &lt; ps)</span><br><span class="line">			pa = p1;</span><br><span class="line">		sz = (pa - ps) + <span class="number">1</span>;</span><br><span class="line">		pp = unflatten_dt_alloc(&amp;mem, <span class="keyword">sizeof</span>(struct property) + sz,</span><br><span class="line">					__alignof__(struct property));</span><br><span class="line">		<span class="keyword">if</span> (!dryrun) &#123;</span><br><span class="line">			pp-&gt;name = <span class="string">"name"</span>;</span><br><span class="line">			pp-&gt;length = sz;</span><br><span class="line">			pp-&gt;value = pp + <span class="number">1</span>;</span><br><span class="line">			*prev_pp = pp;</span><br><span class="line">			prev_pp = &amp;pp-&gt;next;</span><br><span class="line">			<span class="built_in">memcpy</span>(pp-&gt;value, ps, sz - <span class="number">1</span>);</span><br><span class="line">			((<span class="keyword">char</span> *)pp-&gt;value)[sz - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">			pr_debug(<span class="string">"fixed up name for %s -&gt; %s\n"</span>, pathp,</span><br><span class="line">				(<span class="keyword">char</span> *)pp-&gt;value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="comment">/* 根据"name"、 "device_type"属性，来给device_node结构中的name、type成员赋值 */</span></span><br><span class="line">	<span class="keyword">if</span> (!dryrun) &#123;</span><br><span class="line">		*prev_pp = <span class="literal">NULL</span>;</span><br><span class="line">		np-&gt;name = of_get_property(np, <span class="string">"name"</span>, <span class="literal">NULL</span>);</span><br><span class="line">		np-&gt;type = of_get_property(np, <span class="string">"device_type"</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!np-&gt;name)</span><br><span class="line">			np-&gt;name = <span class="string">"&lt;NULL&gt;"</span>;</span><br><span class="line">		<span class="keyword">if</span> (!np-&gt;type)</span><br><span class="line">			np-&gt;type = <span class="string">"&lt;NULL&gt;"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (1.1.3)如果还有子node的存在，递归解析 */</span></span><br><span class="line">	old_depth = depth;</span><br><span class="line">	*poffset = fdt_next_node(blob, *poffset, &amp;depth);</span><br><span class="line">	<span class="keyword">if</span> (depth &lt; <span class="number">0</span>)</span><br><span class="line">		depth = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">while</span> (*poffset &gt; <span class="number">0</span> &amp;&amp; depth &gt; old_depth)</span><br><span class="line">		mem = unflatten_dt_node(blob, mem, poffset, np, <span class="literal">NULL</span>,</span><br><span class="line">					fpsize, dryrun);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (*poffset &lt; <span class="number">0</span> &amp;&amp; *poffset != -FDT_ERR_NOTFOUND)</span><br><span class="line">		pr_err(<span class="string">"unflatten: error %d processing FDT\n"</span>, *poffset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Reverse the child list. Some drivers assumes node order matches .dts</span></span><br><span class="line"><span class="comment">	 * node order</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!dryrun &amp;&amp; np-&gt;child) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">child</span> = <span class="title">np</span>-&gt;<span class="title">child</span>;</span></span><br><span class="line">		np-&gt;child = <span class="literal">NULL</span>;</span><br><span class="line">		<span class="keyword">while</span> (child) &#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">next</span> = <span class="title">child</span>-&gt;<span class="title">sibling</span>;</span></span><br><span class="line">			child-&gt;sibling = np-&gt;child;</span><br><span class="line">			np-&gt;child = child;</span><br><span class="line">			child = next;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (nodepp)</span><br><span class="line">		*nodepp = np;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> mem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2、Device创建"><a href="#3-2、Device创建" class="headerlink" title="3.2、Device创建"></a>3.2、Device创建</h2><h3 id="3-2-1-of-platform-populate"><a href="#3-2-1-of-platform-populate" class="headerlink" title="3.2.1 of_platform_populate()"></a>3.2.1 of_platform_populate()</h3><p>首先root节点下的第1级子节点创建成platform device。</p>
<ul>
<li>对root节点下的第1级子节点，如果有”compatible”属性创建对应platform device；</li>
<li>如果”compatible”属性等于of_default_bus_match_table(“simple-bus”/“simple-mfd”/“arm,amba-bus”)中任意一种，继续对其子节点进行platform device创建。</li>
</ul>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line">start_kernel() -&gt; ... -&gt;do_initcalls() -&gt; arm64_device_init():</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span></span> of_default_bus_match_table[] = &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">"simple-bus"</span>, &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">"simple-mfd"</span>, &#125;,</span><br><span class="line">#ifdef CONFIG_ARM_AMBA</span><br><span class="line">	&#123; .compatible = <span class="string">"arm,amba-bus"</span>, &#125;,</span><br><span class="line">#endif <span class="comment">/* CONFIG_ARM_AMBA */</span></span><br><span class="line">	&#123;&#125; <span class="comment">/* Empty terminated list */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> int __init arm64_device_init(void)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (of_have_populated_dt()) &#123;</span><br><span class="line">		of_iommu_init();</span><br><span class="line">		of_platform_populate(NULL, of_default_bus_match_table,</span><br><span class="line">				     NULL, NULL);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (acpi_disabled) &#123;</span><br><span class="line">		pr_crit(<span class="string">"Device tree not populated\n"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line">int of_platform_populate(<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span></span> *root,</span><br><span class="line">			<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span></span> *matches,</span><br><span class="line">			<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_dev_auxdata</span></span> *lookup,</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">device</span></span> *parent)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span></span> *child;</span><br><span class="line">	int rc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (1) 获取dts中的root node */</span></span><br><span class="line">	root = root ? of_node_get(root) : of_find_node_by_path(<span class="string">"/"</span>);</span><br><span class="line">	<span class="keyword">if</span> (!root)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2) 对root node的child node进行platform device创建 */</span></span><br><span class="line">	for_each_child_of_node(root, child) &#123;</span><br><span class="line">		rc = of_platform_bus_create(child, matches, lookup, parent, <span class="literal">true</span>);</span><br><span class="line">		<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">			of_node_put(child);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	of_node_set_flag(root, OF_POPULATED_BUS);</span><br><span class="line"></span><br><span class="line">	of_node_put(root);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> int of_platform_bus_create(<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span></span> *bus,</span><br><span class="line">				  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span></span> *matches,</span><br><span class="line">				  <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_dev_auxdata</span></span> *lookup,</span><br><span class="line">				  <span class="class"><span class="keyword">struct</span> <span class="title">device</span></span> *parent, <span class="built_in">bool</span> strict)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_dev_auxdata</span></span> *auxdata;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span></span> *child;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span></span> *dev;</span><br><span class="line">	<span class="keyword">const</span> <span class="built_in">char</span> *bus_id = NULL;</span><br><span class="line">	void *platform_data = NULL;</span><br><span class="line">	int rc = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.1) 确保要创建为platform device的node，拥有"compatible"属性 */</span></span><br><span class="line">	<span class="comment">/* Make sure it has a compatible property */</span></span><br><span class="line">	<span class="keyword">if</span> (strict &amp;&amp; (!of_get_property(bus, <span class="string">"compatible"</span>, NULL))) &#123;</span><br><span class="line">		pr_debug(<span class="string">"%s() - skipping %s, no compatible prop\n"</span>,</span><br><span class="line">			 __func__, bus-&gt;full_name);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	auxdata = of_dev_lookup(lookup, bus);</span><br><span class="line">	<span class="keyword">if</span> (auxdata) &#123;</span><br><span class="line">		bus_id = auxdata-&gt;name;</span><br><span class="line">		platform_data = auxdata-&gt;platform_data;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_device_is_compatible(bus, <span class="string">"arm,primecell"</span>)) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Don't return an error here to keep compatibility with older</span></span><br><span class="line"><span class="comment">		 * device tree files.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		of_amba_device_create(bus, bus_id, platform_data, parent);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2) 对当前的node创建platform device */</span></span><br><span class="line">	dev = of_platform_device_create_pdata(bus, bus_id, platform_data, parent);</span><br><span class="line">    <span class="comment">/* (2.3) 根据of_default_bus_match_table，如果node中含有以下属性：</span></span><br><span class="line"><span class="comment">    compatible = "simple-bus"</span></span><br><span class="line"><span class="comment">    compatible = "simple-mfd"</span></span><br><span class="line"><span class="comment">    compatible = "arm,amba-bus"</span></span><br><span class="line"><span class="comment">    则继续对node的子node进行platform device创建</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="keyword">if</span> (!dev || !of_match_node(matches, bus))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.4) 递归对本node的child node进行platform device创建 */</span></span><br><span class="line">	for_each_child_of_node(bus, child) &#123;</span><br><span class="line">		pr_debug(<span class="string">"   create child: %s\n"</span>, child-&gt;full_name);</span><br><span class="line">		rc = of_platform_bus_create(child, matches, lookup, &amp;dev-&gt;dev, strict);</span><br><span class="line">		<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">			of_node_put(child);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	of_node_set_flag(bus, OF_POPULATED_BUS);</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span></span> *of_platform_device_create_pdata(</span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span></span> *np,</span><br><span class="line">					<span class="keyword">const</span> <span class="built_in">char</span> *bus_id,</span><br><span class="line">					void *platform_data,</span><br><span class="line">					<span class="class"><span class="keyword">struct</span> <span class="title">device</span></span> *parent)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span></span> *dev;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!of_device_is_available(np) ||</span><br><span class="line">	    of_node_test_and_set_flag(np, OF_POPULATED))</span><br><span class="line">		<span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.1) 分配node对应的platform_device结构，</span></span><br><span class="line"><span class="comment">     并且解析node中的"reg"、"interrupts"属性，</span></span><br><span class="line"><span class="comment">    作为platform_device-&gt;resource */</span></span><br><span class="line">	dev = of_device_alloc(np, bus_id, parent);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		goto err_clear_flag;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.2) device对应的bus为platform_bus_type  */</span></span><br><span class="line">	dev-&gt;dev.bus = &amp;platform_bus_type;</span><br><span class="line">	dev-&gt;dev.platform_data = platform_data;</span><br><span class="line">	of_dma_configure(&amp;dev-&gt;dev, dev-&gt;dev.of_node);</span><br><span class="line">	of_msi_configure(&amp;dev-&gt;dev, dev-&gt;dev.of_node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.3) 注册platform_device-&gt;dev为标准的device */</span></span><br><span class="line">	<span class="keyword">if</span> (of_device_add(dev) != <span class="number">0</span>) &#123;</span><br><span class="line">		of_dma_deconfigure(&amp;dev-&gt;dev);</span><br><span class="line">		platform_device_put(dev);</span><br><span class="line">		goto err_clear_flag;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line"></span><br><span class="line">err_clear_flag:</span><br><span class="line">	of_node_clear_flag(np, OF_POPULATED);</span><br><span class="line">	<span class="keyword">return</span> NULL;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span></span> *of_device_alloc(<span class="class"><span class="keyword">struct</span> <span class="title">device_node</span></span> *np,</span><br><span class="line">				  <span class="keyword">const</span> <span class="built_in">char</span> *bus_id,</span><br><span class="line">				  <span class="class"><span class="keyword">struct</span> <span class="title">device</span></span> *parent)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">platform_device</span></span> *dev;</span><br><span class="line">	int rc, i, num_reg = <span class="number">0</span>, num_irq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">resource</span></span> *res, temp_res;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.1.1) 分配platform_device空间  */</span></span><br><span class="line">	dev = platform_device_alloc(<span class="string">""</span>, -<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (!dev)</span><br><span class="line">		<span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.1.2) 计算node中"reg"属性中"address、size"resource的个数  */</span></span><br><span class="line">	<span class="comment">/* count the io and irq resources */</span></span><br><span class="line">	<span class="keyword">while</span> (of_address_to_resource(np, num_reg, &amp;temp_res) == <span class="number">0</span>)</span><br><span class="line">		num_reg++;</span><br><span class="line">	num_irq = of_irq_count(np); <span class="comment">/* 计算node中"interrupts"属性中irq的个数 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.1.3) 给resource分配空间并解析值 */</span></span><br><span class="line">	<span class="comment">/* Populate the resource table */</span></span><br><span class="line">	<span class="keyword">if</span> (num_irq || num_reg) &#123;</span><br><span class="line">		res = kzalloc(sizeof(*res) * (num_irq + num_reg), GFP_KERNEL);</span><br><span class="line">		<span class="keyword">if</span> (!res) &#123;</span><br><span class="line">			platform_device_put(dev);</span><br><span class="line">			<span class="keyword">return</span> NULL;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		dev-&gt;num_resources = num_reg + num_irq;</span><br><span class="line">		dev-&gt;resource = res;</span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_reg; i++, res++) &#123;</span><br><span class="line">			rc = of_address_to_resource(np, i, res);</span><br><span class="line">			WARN_ON(rc);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (of_irq_to_resource_table(np, res, num_irq) != num_irq)</span><br><span class="line">			pr_debug(<span class="string">"not all legacy IRQ resources mapped for %s\n"</span>,</span><br><span class="line">				 np-&gt;name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.1.4) 根据device能够找到of node  */</span></span><br><span class="line">	dev-&gt;dev.of_node = of_node_get(np);</span><br><span class="line">	dev-&gt;dev.parent = parent ? : &amp;platform_bus;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* (2.2.1.5) 配置device的那么，基本命名规则为：</span></span><br><span class="line"><span class="comment">    dev_set_name(dev, dev_name(dev) ? "%llx.%s:%s" : "%llx.%s",</span></span><br><span class="line"><span class="comment">    				     (unsigned long long)addr, node-&gt;name,</span></span><br><span class="line"><span class="comment">    				     dev_name(dev))</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">if</span> (bus_id)</span><br><span class="line">		dev_set_name(&amp;dev-&gt;dev, <span class="string">"%s"</span>, bus_id);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		of_device_make_bus_id(&amp;dev-&gt;dev);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> dev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-mt-i2c-driver"><a href="#3-2-2-mt-i2c-driver" class="headerlink" title="3.2.2 mt_i2c_driver"></a>3.2.2 mt_i2c_driver</h3><p>因为第1级子节点会被注册成platform device，例如i2c/spi控制器，那么对应也需要注册platform driver。已i2c控制器驱动为例：</p>
<ul>
<li>控制器首先会创建对应platform driver，把adapter注册成i2c device；</li>
<li>在adapter的probe过程中，会调用of_i2c_register_devices()函数遍历控制器下挂的i2c设备的DTS节点，并将其注册成i2c_client；</li>
</ul>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br></pre></td><td class="code"><pre><span class="line">drivers\i2c\busses\i2c-mtk.c:</span><br><span class="line"></span><br><span class="line">static const struct of_device_id mtk_i2c_of_match[] = &#123;</span><br><span class="line">	&#123; .compatible = <span class="string">"mediatek,mt6735-i2c"</span>, .<span class="keyword">data</span> = &amp;mt6735_compat &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">"mediatek,mt6797-i2c"</span>, .<span class="keyword">data</span> = &amp;mt6797_compat &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">"mediatek,mt6757-i2c"</span>, .<span class="keyword">data</span> = &amp;mt6757_compat &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">"mediatek,mt6799-i2c"</span>, .<span class="keyword">data</span> = &amp;mt6799_compat &#125;,</span><br><span class="line">	&#123; .compatible = <span class="string">"mediatek,elbrus-i2c"</span>, .<span class="keyword">data</span> = &amp;elbrus_compat &#125;,</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct platform_driver mt_i2c_driver = &#123;</span><br><span class="line">	.probe = mt_i2c_probe,</span><br><span class="line">	.remove = mt_i2c_remove,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.<span class="keyword">name</span> = I2C_DRV_NAME,</span><br><span class="line">		.owner = THIS_MODULE,</span><br><span class="line">		.of_match_table = of_match_ptr(mtk_i2c_of_match),</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static int mt_i2c_probe(struct platform_device *pdev)</span><br><span class="line">&#123;</span><br><span class="line">	int ret = <span class="number">0</span>;</span><br><span class="line">	struct mt_i2c *i2c;</span><br><span class="line">	unsigned int clk_src_in_hz;</span><br><span class="line">	struct resource *res;</span><br><span class="line">	const struct of_device_id *of_id;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">i2c</span> = devm_kzalloc(&amp;pdev-&gt;</span>dev, sizeof(struct mt_i2c), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (i2c == NULL)</span><br><span class="line">		return -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = mt_i2c_parse_dt(pdev-&gt;</span>dev.of_node, i2c);</span><br><span class="line">	<span class="keyword">if</span> (ret)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">base</span> = devm_ioremap_resource(&amp;pdev-&gt;</span>dev, res);</span><br><span class="line">	<span class="function"><span class="title">if</span> (IS_ERR(i2c-&gt;</span>base))</span><br><span class="line">		<span class="function"><span class="title">return</span> PTR_ERR(i2c-&gt;</span>base);</span><br><span class="line"></span><br><span class="line">	res = platform_get_resource(pdev, IORESOURCE_MEM, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">pdmabase</span> = devm_ioremap_resource(&amp;pdev-&gt;</span>dev, res);</span><br><span class="line">	<span class="function"><span class="title">if</span> (IS_ERR(i2c-&gt;</span>pdmabase))</span><br><span class="line">		<span class="function"><span class="title">return</span> PTR_ERR(i2c-&gt;</span>pdmabase);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span>irqnr = platform_get_irq(pdev, <span class="number">0</span>);</span><br><span class="line">	<span class="function"><span class="title">if</span> (i2c-&gt;</span>irqnr &lt;= <span class="number">0</span>)</span><br><span class="line">		return -EINVAL;</span><br><span class="line">	<span class="function"><span class="title">init_waitqueue_head</span>(&amp;i2c-&gt;</span>wait);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">ret</span> = devm_request_irq(&amp;pdev-&gt;</span><span class="function"><span class="title">dev</span>, i2c-&gt;</span>irqnr, mt_i2c_irq,</span><br><span class="line">#ifdef CONFIG_MEIZU_BSP</span><br><span class="line">		IRQF_NO_SUSPEND | IRQF_TRIGGER_NONE, I2C_DRV_NAME, i2c);</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">		IRQF_TRIGGER_NONE, I2C_DRV_NAME, i2c);</span><br><span class="line">#endif <span class="comment">/*CONFIG_MEIZU_BSP*/</span></span><br><span class="line">	<span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev,</span><br><span class="line">			<span class="string">"Request I2C IRQ %d fail\n"</span>, <span class="function"><span class="title">i2c</span>-&gt;</span>irqnr);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">of_id</span> = of_match_node(mtk_i2c_of_match, pdev-&gt;</span>dev.of_node);</span><br><span class="line">	<span class="keyword">if</span> (!of_id)</span><br><span class="line">		return -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">dev_comp</span> = of_id-&gt;</span><span class="keyword">data</span>;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">adap</span>.dev.of_node = pdev-&gt;</span>dev.of_node;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">dev</span> = &amp;i2c-&gt;</span>adap.dev;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">adap</span>.dev.parent = &amp;pdev-&gt;</span>dev;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span>adap.owner = THIS_MODULE;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span>adap.algo = &amp;mt_i2c_algorithm;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span>adap.algo_data = NULL;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span>adap.timeout = <span class="number">2</span> * HZ;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span>adap.retries = <span class="number">1</span>;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">adap</span>.nr = i2c-&gt;</span>id;</span><br><span class="line">	<span class="function"><span class="title">spin_lock_init</span>(&amp;i2c-&gt;</span>cg_lock);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">if</span> (i2c-&gt;</span><span class="function"><span class="title">dev_comp</span>-&gt;</span>dma_support == <span class="number">2</span>) &#123;</span><br><span class="line">		<span class="function"><span class="title">if</span> (dma_set_mask(&amp;pdev-&gt;</span>dev, DMA_BIT_MASK(<span class="number">33</span>))) &#123;</span><br><span class="line">			<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"dma_set_mask return error.\n"</span>);</span><br><span class="line">			return -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="function"><span class="title">else</span> <span class="keyword">if</span> (i2c-&gt;</span><span class="function"><span class="title">dev_comp</span>-&gt;</span>dma_support == <span class="number">3</span>) &#123;</span><br><span class="line">		<span class="function"><span class="title">if</span> (dma_set_mask(&amp;pdev-&gt;</span>dev, DMA_BIT_MASK(<span class="number">36</span>))) &#123;</span><br><span class="line">			<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"dma_set_mask return error.\n"</span>);</span><br><span class="line">			return -EINVAL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> !defined(CONFIG_MT_I2C_FPGA_ENABLE)</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">clk_main</span> = devm_clk_get(&amp;pdev-&gt;</span>dev, <span class="string">"main"</span>);</span><br><span class="line">	<span class="function"><span class="title">if</span> (IS_ERR(i2c-&gt;</span>clk_main)) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"cannot get main clock\n"</span>);</span><br><span class="line">		<span class="function"><span class="title">return</span> PTR_ERR(i2c-&gt;</span>clk_main);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">clk_dma</span> = devm_clk_get(&amp;pdev-&gt;</span>dev, <span class="string">"dma"</span>);</span><br><span class="line">	<span class="function"><span class="title">if</span> (IS_ERR(i2c-&gt;</span>clk_dma)) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"cannot get dma clock\n"</span>);</span><br><span class="line">		<span class="function"><span class="title">return</span> PTR_ERR(i2c-&gt;</span>clk_dma);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">clk_arb</span> = devm_clk_get(&amp;pdev-&gt;</span>dev, <span class="string">"arb"</span>);</span><br><span class="line">	<span class="function"><span class="title">if</span> (IS_ERR(i2c-&gt;</span>clk_arb))</span><br><span class="line">		<span class="function"><span class="title">i2c</span>-&gt;</span>clk_arb = NULL;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="function"><span class="title">dev_dbg</span>(&amp;pdev-&gt;</span><span class="function"><span class="title">dev</span>, "i2c%d has the relevant arbitrator clk.\n", i2c-&gt;</span>id);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">if</span> (i2c-&gt;</span>have_pmic) &#123;</span><br><span class="line">		<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">clk_pmic</span> = devm_clk_get(&amp;pdev-&gt;</span>dev, <span class="string">"pmic"</span>);</span><br><span class="line">		<span class="function"><span class="title">if</span> (IS_ERR(i2c-&gt;</span>clk_pmic)) &#123;</span><br><span class="line">			<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"cannot get pmic clock\n"</span>);</span><br><span class="line">			<span class="function"><span class="title">return</span> PTR_ERR(i2c-&gt;</span>clk_pmic);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="function"><span class="title">clk_src_in_hz</span> = clk_get_rate(i2c-&gt;</span><span class="function"><span class="title">clk_pmic</span>) / i2c-&gt;</span>clk_src_div;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="function"><span class="title">clk_src_in_hz</span> = clk_get_rate(i2c-&gt;</span><span class="function"><span class="title">clk_main</span>) / i2c-&gt;</span>clk_src_div;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">dev_dbg</span>(&amp;pdev-&gt;</span>dev, <span class="string">"clock source %p,clock src frequency %d\n"</span>,</span><br><span class="line">		<span class="function"><span class="title">i2c</span>-&gt;</span>clk_main, clk_src_in_hz);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">strlcpy</span>(i2c-&gt;</span><span class="function"><span class="title">adap</span>.<span class="keyword">name</span>, I2C_DRV_NAME, sizeof(i2c-&gt;</span>adap.<span class="keyword">name</span>));</span><br><span class="line">	<span class="function"><span class="title">mutex_init</span>(&amp;i2c-&gt;</span>i2c_mutex);</span><br><span class="line">	ret = i2c_set_speed(i2c, clk_src_in_hz);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"Failed to set the speed\n"</span>);</span><br><span class="line">		return -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	ret = mt_i2c_clock_enable(i2c);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"clock enable failed!\n"</span>);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;</span><br><span class="line">	mt_i2c_init_hw(i2c);</span><br><span class="line">	mt_i2c_clock_disable(i2c);</span><br><span class="line">	<span class="function"><span class="title">i2c</span>-&gt;</span><span class="function"><span class="title">dma_buf</span>.vaddr = dma_alloc_coherent(&amp;pdev-&gt;</span>dev,</span><br><span class="line">		PAGE_SIZE, &amp;<span class="function"><span class="title">i2c</span>-&gt;</span>dma_buf.paddr, GFP_KERNEL);</span><br><span class="line">	<span class="function"><span class="title">if</span> (i2c-&gt;</span>dma_buf.vaddr == NULL) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"dma_alloc_coherent fail\n"</span>);</span><br><span class="line">		return -ENOMEM;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">i2c_set_adapdata</span>(&amp;i2c-&gt;</span>adap, i2c);</span><br><span class="line">	<span class="comment">/* ret = i2c_add_adapter(&amp;i2c-&gt;adap); */</span></span><br><span class="line">	<span class="function"><span class="title">ret</span> = i2c_add_numbered_adapter(&amp;i2c-&gt;</span>adap);</span><br><span class="line">	<span class="keyword">if</span> (ret) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;pdev-&gt;</span>dev, <span class="string">"Failed to add i2c bus to i2c core\n"</span>);</span><br><span class="line">		free_i2c_dma_bufs(i2c);</span><br><span class="line">		return ret;</span><br><span class="line">	&#125;</span><br><span class="line">	platform_set_drvdata(pdev, i2c);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!map_cg_regs(i2c))</span><br><span class="line">		pr_warn(<span class="string">"Map cg regs successfully.\n"</span>);</span><br><span class="line"></span><br><span class="line">	return <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">i2c_add_numbered_adapter</span>() -&gt;</span> __<span class="function"><span class="title">i2c_add_numbered_adapter</span>() -&gt;</span> </span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line">static int i2c_register_adapter(struct i2c_adapter *adap)</span><br><span class="line">&#123;</span><br><span class="line">	int res = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Can't register until after driver model init */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(WARN_ON(!i2c_bus_type.p))) &#123;</span><br><span class="line">		res = -EAGAIN;</span><br><span class="line">		goto out_list;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Sanity checks */</span></span><br><span class="line">	<span class="function"><span class="title">if</span> (unlikely(adap-&gt;</span><span class="keyword">name</span>[<span class="number">0</span>] == <span class="string">'\0'</span>)) &#123;</span><br><span class="line">		pr_err(<span class="string">"i2c-core: Attempt to register an adapter with "</span></span><br><span class="line">		       <span class="string">"no name!\n"</span>);</span><br><span class="line">		return -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="title">if</span> (unlikely(!adap-&gt;</span>algo)) &#123;</span><br><span class="line">		pr_err(<span class="string">"i2c-core: Attempt to register adapter '%s' with "</span></span><br><span class="line">		       <span class="string">"no algo!\n"</span>, <span class="function"><span class="title">adap</span>-&gt;</span><span class="keyword">name</span>);</span><br><span class="line">		return -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">rt_mutex_init</span>(&amp;adap-&gt;</span>bus_lock);</span><br><span class="line">	<span class="function"><span class="title">mutex_init</span>(&amp;adap-&gt;</span>userspace_clients_lock);</span><br><span class="line">	INIT_LIST_HEAD(&amp;<span class="function"><span class="title">adap</span>-&gt;</span>userspace_clients);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set default timeout to 1 second if not already set */</span></span><br><span class="line">	<span class="function"><span class="title">if</span> (adap-&gt;</span>timeout == <span class="number">0</span>)</span><br><span class="line">		<span class="function"><span class="title">adap</span>-&gt;</span>timeout = HZ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 注册adapter为i2c_bus上的device */</span></span><br><span class="line">	<span class="function"><span class="title">dev_set_name</span>(&amp;adap-&gt;</span><span class="function"><span class="title">dev</span>, "i2c-%d", adap-&gt;</span>nr);</span><br><span class="line">	<span class="function"><span class="title">adap</span>-&gt;</span>dev.bus = &amp;i2c_bus_type;</span><br><span class="line">	<span class="function"><span class="title">adap</span>-&gt;</span>dev.type = &amp;i2c_adapter_type;</span><br><span class="line">	<span class="function"><span class="title">res</span> = device_register(&amp;adap-&gt;</span>dev);</span><br><span class="line">	<span class="keyword">if</span> (res)</span><br><span class="line">		goto out_list;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">dev_dbg</span>(&amp;adap-&gt;</span><span class="function"><span class="title">dev</span>, "adapter [%s] registered\n", adap-&gt;</span><span class="keyword">name</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">pm_runtime_no_callbacks</span>(&amp;adap-&gt;</span>dev);</span><br><span class="line"></span><br><span class="line">#ifdef CONFIG_I2C_COMPAT</span><br><span class="line">	<span class="function"><span class="title">res</span> = class_compat_create_link(i2c_adapter_compat_class, &amp;adap-&gt;</span>dev,</span><br><span class="line">				       <span class="function"><span class="title">adap</span>-&gt;</span>dev.parent);</span><br><span class="line">	<span class="keyword">if</span> (res)</span><br><span class="line">		<span class="function"><span class="title">dev_warn</span>(&amp;adap-&gt;</span>dev,</span><br><span class="line">			 <span class="string">"Failed to create compatibility class link\n"</span>);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* bus recovery specific initialization */</span></span><br><span class="line">	<span class="function"><span class="title">if</span> (adap-&gt;</span>bus_recovery_info) &#123;</span><br><span class="line">		<span class="function"><span class="title">struct</span> i2c_bus_recovery_info *bri = adap-&gt;</span>bus_recovery_info;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="title">if</span> (!bri-&gt;</span>recover_bus) &#123;</span><br><span class="line">			<span class="function"><span class="title">dev_err</span>(&amp;adap-&gt;</span>dev, <span class="string">"No recover_bus() found, not using recovery\n"</span>);</span><br><span class="line">			<span class="function"><span class="title">adap</span>-&gt;</span>bus_recovery_info = NULL;</span><br><span class="line">			goto exit_recovery;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Generic GPIO recovery */</span></span><br><span class="line">		<span class="function"><span class="title">if</span> (bri-&gt;</span>recover_bus == i2c_generic_gpio_recovery) &#123;</span><br><span class="line">			<span class="function"><span class="title">if</span> (!gpio_is_valid(bri-&gt;</span>scl_gpio)) &#123;</span><br><span class="line">				<span class="function"><span class="title">dev_err</span>(&amp;adap-&gt;</span>dev, <span class="string">"Invalid SCL gpio, not using recovery\n"</span>);</span><br><span class="line">				<span class="function"><span class="title">adap</span>-&gt;</span>bus_recovery_info = NULL;</span><br><span class="line">				goto exit_recovery;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="title">if</span> (gpio_is_valid(bri-&gt;</span>sda_gpio))</span><br><span class="line">				<span class="function"><span class="title">bri</span>-&gt;</span>get_sda = get_sda_gpio_value;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">				<span class="function"><span class="title">bri</span>-&gt;</span>get_sda = NULL;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="title">bri</span>-&gt;</span>get_scl = get_scl_gpio_value;</span><br><span class="line">			<span class="function"><span class="title">bri</span>-&gt;</span>set_scl = set_scl_gpio_value;</span><br><span class="line">		&#125; <span class="function"><span class="title">else</span> <span class="keyword">if</span> (!bri-&gt;</span><span class="function"><span class="title">set_scl</span> || !bri-&gt;</span>get_scl) &#123;</span><br><span class="line">			<span class="comment">/* Generic SCL recovery */</span></span><br><span class="line">			<span class="function"><span class="title">dev_err</span>(&amp;adap-&gt;</span>dev, <span class="string">"No &#123;get|set&#125;_gpio() found, not using recovery\n"</span>);</span><br><span class="line">			<span class="function"><span class="title">adap</span>-&gt;</span>bus_recovery_info = NULL;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">exit_recovery:</span><br><span class="line">	<span class="comment">/* create pre-declared device nodes */</span></span><br><span class="line">    <span class="comment">/* 循环遍历adapter node下挂载的其他子node，注册成为i2c bus的device */</span></span><br><span class="line">	of_i2c_register_devices(adap);</span><br><span class="line">	acpi_i2c_register_devices(adap);</span><br><span class="line">	acpi_i2c_install_space_handler(adap);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">if</span> (adap-&gt;</span>nr &lt; __i2c_first_dynamic_bus_num)</span><br><span class="line">		i2c_scan_static_board_info(adap);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Notify drivers */</span></span><br><span class="line">	mutex_lock(&amp;core_lock);</span><br><span class="line">	bus_for_each_drv(&amp;i2c_bus_type, NULL, adap, __process_new_adapter);</span><br><span class="line">	mutex_unlock(&amp;core_lock);</span><br><span class="line"></span><br><span class="line">	return <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_list:</span><br><span class="line">	mutex_lock(&amp;core_lock);</span><br><span class="line">	<span class="function"><span class="title">idr_remove</span>(&amp;i2c_adapter_idr, adap-&gt;</span>nr);</span><br><span class="line">	mutex_unlock(&amp;core_lock);</span><br><span class="line">	return res;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line">static void of_i2c_register_devices(struct i2c_adapter *adap)</span><br><span class="line">&#123;</span><br><span class="line">	struct device_node *node;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Only register child devices if the adapter has a node pointer set */</span></span><br><span class="line">	<span class="function"><span class="title">if</span> (!adap-&gt;</span>dev.of_node)</span><br><span class="line">		return;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">dev_dbg</span>(&amp;adap-&gt;</span>dev, <span class="string">"of_i2c: walking child nodes\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 遍历adapter node下的子node，并创建标准的i2c bus的device */</span></span><br><span class="line">	<span class="function"><span class="title">for_each_available_child_of_node</span>(adap-&gt;</span>dev.of_node, node) &#123;</span><br><span class="line">		<span class="keyword">if</span> (of_node_test_and_set_flag(node, OF_POPULATED))</span><br><span class="line">			continue;</span><br><span class="line">		of_i2c_register_device(adap, node);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">↓</span><br><span class="line"></span><br><span class="line">static struct i2c_client *of_i2c_register_device(struct i2c_adapter *adap,</span><br><span class="line">						 struct device_node *node)</span><br><span class="line">&#123;</span><br><span class="line">	struct i2c_client *result;</span><br><span class="line">	struct i2c_board_info info = &#123;&#125;;</span><br><span class="line">	struct dev_archdata dev_ad = &#123;&#125;;</span><br><span class="line">	const __be32 *addr_be;</span><br><span class="line">	u32 addr;</span><br><span class="line">	int len;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="title">dev_dbg</span>(&amp;adap-&gt;</span><span class="function"><span class="title">dev</span>, "of_i2c: register %s\n", node-&gt;</span>full_name);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_modalias_node(node, info.type, sizeof(info.type)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;adap-&gt;</span>dev, <span class="string">"of_i2c: modalias failure on %s\n"</span>,</span><br><span class="line">			<span class="function"><span class="title">node</span>-&gt;</span>full_name);</span><br><span class="line">		return ERR_PTR(-EINVAL);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addr_be = of_get_property(node, <span class="string">"reg"</span>, &amp;len);</span><br><span class="line">	<span class="keyword">if</span> (!addr_be || (len &lt; sizeof(*addr_be))) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;adap-&gt;</span>dev, <span class="string">"of_i2c: invalid reg on %s\n"</span>,</span><br><span class="line">			<span class="function"><span class="title">node</span>-&gt;</span>full_name);</span><br><span class="line">		return ERR_PTR(-EINVAL);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	addr = be32_to_cpup(addr_be);</span><br><span class="line">	<span class="keyword">if</span> (addr &amp; I2C_TEN_BIT_ADDRESS) &#123;</span><br><span class="line">		addr &amp;= ~I2C_TEN_BIT_ADDRESS;</span><br><span class="line">		info.flags |= I2C_CLIENT_TEN;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (addr &amp; I2C_OWN_SLAVE_ADDRESS) &#123;</span><br><span class="line">		addr &amp;= ~I2C_OWN_SLAVE_ADDRESS;</span><br><span class="line">		info.flags |= I2C_CLIENT_SLAVE;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (i2c_check_addr_validity(addr, info.flags)) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;adap-&gt;</span>dev, <span class="string">"of_i2c: invalid addr=%x on %s\n"</span>,</span><br><span class="line">			<span class="function"><span class="title">info</span>.addr, node-&gt;</span>full_name);</span><br><span class="line">		return ERR_PTR(-EINVAL);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	info.addr = addr;</span><br><span class="line">	info.of_node = of_node_get(node);</span><br><span class="line">	info.archdata = &amp;dev_ad;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (of_get_property(node, <span class="string">"wakeup-source"</span>, NULL))</span><br><span class="line">		info.flags |= I2C_CLIENT_WAKE;</span><br><span class="line"></span><br><span class="line">	result = i2c_new_device(adap, &amp;info);</span><br><span class="line">	<span class="keyword">if</span> (result == NULL) &#123;</span><br><span class="line">		<span class="function"><span class="title">dev_err</span>(&amp;adap-&gt;</span>dev, <span class="string">"of_i2c: Failure registering %s\n"</span>,</span><br><span class="line">			<span class="function"><span class="title">node</span>-&gt;</span>full_name);</span><br><span class="line">		of_node_put(node);</span><br><span class="line">		return ERR_PTR(-EINVAL);</span><br><span class="line">	&#125;</span><br><span class="line">	return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-1-mz-mag-driver"><a href="#3-2-1-mz-mag-driver" class="headerlink" title="3.2.1 mz_mag_driver"></a>3.2.1 mz_mag_driver</h3><p>具体的I2c设备驱动，在总线驱动使用of_i2c_register_devices()创建设备以后，就可以适配工作了。</p>
<p>dts：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">arch\arm64\boot\dts\mediatek\mt6799.dtsi:</span><br><span class="line"><span class="symbol">	i2c1:</span> <span class="class">i2c@11090000 </span>&#123;</span><br><span class="line">		compatible = <span class="string">"mediatek,mt6799-i2c"</span>;</span><br><span class="line">		id = <span class="params">&lt;<span class="number">1</span>&gt;</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0</span> <span class="number">0x11090000</span> <span class="number">0</span> <span class="number">0x1000</span>&gt;</span>,</span><br><span class="line">			<span class="params">&lt;<span class="number">0</span> <span class="number">0x11000100</span> <span class="number">0</span> <span class="number">0x80</span>&gt;</span>;</span><br><span class="line">		interrupts = <span class="params">&lt;GIC_SPI <span class="number">85</span> IRQ_TYPE_LEVEL_LOW&gt;</span>;</span><br><span class="line">		clocks = <span class="params">&lt;<span class="variable">&amp;pericfg</span> CLK_PERICFG_RG_I2C1_BCLK&gt;</span>, <span class="params">&lt;<span class="variable">&amp;pericfg</span> CLK_PERICFG_RG_AP_DM&gt;</span>;</span><br><span class="line">		clock-names = <span class="string">"main"</span>, <span class="string">"dma"</span>;</span><br><span class="line">		clock-div = <span class="params">&lt;<span class="number">5</span>&gt;</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">arch\arm64\boot\dts\mediatek\mz6799_6m_v2_2k_n.dtsi:</span><br><span class="line"><span class="variable">&amp;i2c1</span> &#123;</span><br><span class="line"><span class="symbol">	apds9922:</span><span class="class">apds9922@53 </span>&#123;</span><br><span class="line">		compatible = <span class="string">"mediatek,apds9922"</span>;</span><br><span class="line">		interrupt-parent = <span class="params">&lt;<span class="variable">&amp;eintc</span>&gt;</span>;</span><br><span class="line">		interrupts = <span class="params">&lt; <span class="number">8</span> IRQ_TYPE_EDGE_FALLING&gt;</span>;</span><br><span class="line">		debounce = <span class="params">&lt;<span class="number">8</span> <span class="number">0</span>&gt;</span>;</span><br><span class="line">		gpio = <span class="params">&lt; <span class="number">8</span> &gt;</span>;</span><br><span class="line">		reg = <span class="params">&lt;<span class="number">0x53</span>&gt;</span>;</span><br><span class="line">		status = <span class="string">"okay"</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>driver：</p>
<figure class="highlight capnproto"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">drivers\iio\magnetometer\mz_mag.c:</span><br><span class="line">static <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">i2c_device_id</span> mz_mag_id[] = </span>&#123;</span><br><span class="line">	&#123;<span class="string">"mediatek,mmc3530"</span>, <span class="number">0</span> &#125;,</span><br><span class="line">	&#123;<span class="string">"mediatek,akm09911"</span>, <span class="number">1</span> &#125;,</span><br><span class="line">	&#123; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static <span class="class"><span class="keyword">struct</span> <span class="title">i2c_driver</span> mz_mag_driver = </span>&#123;</span><br><span class="line">	.probe     = mz_mag_probe,</span><br><span class="line">	.id_table  = mz_mag_id,</span><br><span class="line">	.driver = &#123;</span><br><span class="line">		.name  = MZ_MAG_DEV_NAME,</span><br><span class="line">		.owner = THIS_MODULE,</span><br><span class="line">		<span class="comment">#ifdef CONFIG_OF</span></span><br><span class="line">    	.of_match_table = of_match_ptr(msensor_of_match),</span><br><span class="line">		<span class="comment">#endif</span></span><br><span class="line">	&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

                
                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/07/11//linux-time.html/" data-toggle="tooltip" data-placement="top" title="Linux Time">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/12/26//tee.html/" data-toggle="tooltip" data-placement="top" title="TEE 软件交互流程概述">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- tip start -->
                

                
                <div class="comment_notes">
                    <p>
                        This is copyright.
                    </p>
                </div>
                
                <!-- tip end -->

                <!-- Music start-->
                
                <!-- Music end -->

                <!-- Sharing -->
                
                <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                <!--  css & js -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!-- Sharing -->

                <!-- gitment start -->
                
                <!-- gitment end -->

                <!-- 来必力City版安装代码 -->
                
                <!-- City版安装代码已完成 -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#DTS" title="DTS">DTS</a>
                        
                          <a class="tag" href="/tags/#DTB" title="DTB">DTB</a>
                        
                          <a class="tag" href="/tags/#DTC" title="DTC">DTC</a>
                        
                          <a class="tag" href="/tags/#Node" title="Node">Node</a>
                        
                          <a class="tag" href="/tags/#Property" title="Property">Property</a>
                        
                          <a class="tag" href="/tags/#OpenFirmware" title="OpenFirmware">OpenFirmware</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="#" target="_blank">Other</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>


<style  type="text/css">
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">

                

                

                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; meizu 2024 
                    <br>
                    Powered by 
                    <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener">
                        <i>hexo-theme-snail</i>
                    </a> | 
                    <iframe name="star" style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0"
                        width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=dusign&repo=hexo-theme-snail&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>

</footer>

<!-- jQuery -->

<script src="../../../../../js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="../../../../../js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="../../../../../js/hux-blog.min.js"></script>


<!-- Search -->

<script src="../../../../../js/search.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://kernel.meizu.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Search -->

    <script type="text/javascript">      
        var search_path = "search.xml";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
    var path = "/" + search_path;
    searchFunc(path, 'local-search-input', 'local-search-result');
    </script>


<!-- busuanzi -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>

    
        <!-- background effects line -->
        

        
            <script type="text/javascript" src="/js/mouse-click.js" content='[&quot;🌱&quot;,&quot;just do it&quot;,&quot;🍀&quot;]' color='[&quot;rgb(121,93,179)&quot; ,&quot;rgb(76,180,231)&quot; ,&quot;rgb(184,90,154)&quot;]'></script>
        

        <!-- background effects end -->
    

    <!--<script size="50" alpha='0.3' zIndex="-999" src="/js/ribbonStatic.js"></script>-->
    
        <script src="/js/ribbonDynamic.js"></script>
    
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
