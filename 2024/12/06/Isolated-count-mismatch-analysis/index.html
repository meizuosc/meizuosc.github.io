<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="baidu-site-verification" content="093lY4ziMu" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="一个有内涵的技术分享平台">
    <meta name="keyword"  content="meizu,kernel,魅族">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <!--<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>-->
    <title>
        
          一次山重水复疑无路的卡死问题根源分析 - 魅族内核团队
        
    </title>

    <link rel="canonical" href="https://kernel.meizu.com/2024/12/06/Isolated-count-mismatch-analysis/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="../../../../css/bootstrap.min.css">


    <!-- Custom CSS --> 
    
        
<link rel="stylesheet" href="../../../../css/dusign-light.css">

        
<link rel="stylesheet" href="../../../../css/dusign-common-light.css">

        
<link rel="stylesheet" href="../../../../css/font-awesome.css">

        
<link rel="stylesheet" href="../../../../css/toc.css">

        <!-- background effects end -->
    
    
    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="../../../../css/highlight.css">


    
<link rel="stylesheet" href="../../../../css/widget.css">


    
<link rel="stylesheet" href="../../../../css/rocket.css">


    
<link rel="stylesheet" href="../../../../css/signature.css">


    
<link rel="stylesheet" href="../../../../css/fonts.googleapis.css">


    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <!-- photography -->
    
<link rel="stylesheet" href="../../../../css/photography.css">


    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- background effects start -->
    
    <!-- background effects end -->

	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            
                background-image: linear-gradient(rgba(0, 0, 0, 0.3), rgba(0, 0, 0, 0.3)), url('../../../../img/default.jpg')
                /*post*/
            
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                        </div>
                        <h1>一次山重水复疑无路的卡死问题根源分析</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Lotte on
                            2024-12-06
                        </span>

                        

                    </div>
                

                </div>
            </div>
        </div>      
    </div>

    
    <div class="waveWrapper">
        <div class="wave wave_before" style="background-image: url('/img/wave-light.png')"></div>
        <div class="wave wave_after" style="background-image: url('/img/wave-light.png')"></div>
    </div>
    
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">魅族内核团队</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/categories/">Categories</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h2 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h2><p>一个项目中偶现几十上百个 D 进程卡住在 shrink_inactive_list，导致卡顿/卡死/android SWT 等问题，前前后后，提交了 3 次修复，还没有彻底解决。</p>
<h2 id="山重水复疑无路"><a href="#山重水复疑无路" class="headerlink" title="山重水复疑无路"></a>山重水复疑无路</h2><p>LOG：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[149459.897408] [3:2065:watchdog] Binder:1042_16 D 0 9917 635 0x00000008</span><br><span class="line">[149459.897427] [3:2065:watchdog] Call trace:</span><br><span class="line">[149459.897435] [3:2065:watchdog] [&lt;ffffff8bf28852d4&gt;] _switch_to+0xb4&#x2F;0xc0</span><br><span class="line">[149459.897452] [3:2065:watchdog] [&lt;ffffff8bf3a1f6a0&gt;] _schedule+0x7f0&#x2F;0xad0</span><br><span class="line">[149459.897468] [3:2065:watchdog] [&lt;ffffff8bf3a1f9f0&gt;] schedule+0x70&#x2F;0x90</span><br><span class="line">[149459.897485] [3:2065:watchdog] [&lt;ffffff8bf3a23b00&gt;] schedule_timeout+0x548&#x2F;0x668</span><br><span class="line">[149459.897502] [3:2065:watchdog] [&lt;ffffff8bf2959028&gt;] msleep+0x28&#x2F;0x38</span><br><span class="line">[149459.897517] [3:2065:watchdog] [&lt;ffffff8bf2a1ff38&gt;] shrink_inactive_list+0x118&#x2F;0x998</span><br><span class="line">[149459.897534] [3:2065:watchdog] [&lt;ffffff8bf2a1cb10&gt;] shrink_node_memcg+0xa18&#x2F;0x1100</span><br><span class="line">[149459.897552] [3:2065:watchdog] [&lt;ffffff8bf2a1f0b0&gt;] shrink_node+0x108&#x2F;0x2f8</span><br><span class="line">[149459.897568] [3:2065:watchdog] [&lt;ffffff8bf2a1bcb0&gt;] do_try_to_free_pages+0x178&#x2F;0x380</span><br><span class="line">[149459.897586] [3:2065:watchdog] [&lt;ffffff8bf2a1b9d0&gt;] try_to_free_pages+0x370&#x2F;0x4d8</span><br><span class="line">[149459.897605] [3:2065:watchdog] [&lt;ffffff8bf2a071b8&gt;] _alloc_pages_nodemask+0x868&#x2F;0x1380</span><br><span class="line">[149459.897623] [3:2065:watchdog] [&lt;ffffff8bf2a13784&gt;] __do_pagecache_readahead+0xbc&#x2F;0x358</span><br><span class="line">[149459.897640] [3:2065:watchdog] [&lt;ffffff8bf29fde4c&gt;] filemapfault+0x11c&#x2F;0x600</span><br><span class="line">[149459.897647] [3:2065:watchdog] [&lt;ffffff8bf2b479f8&gt;] ext4_filemap_fault+0x30&#x2F;0x50</span><br><span class="line">[149459.897664] [3:2065:watchdog] [&lt;ffffff8bf2a47f38&gt;] handle_pte_fault+0xb38&#x2F;0xfa8</span><br><span class="line">[149459.897681] [3:2065:watchdog] [&lt;ffffff8bf2a485c8&gt;] handle_mm_fault+0x1d0&#x2F;0x328</span><br><span class="line">[149459.897699] [3:2065:watchdog] [&lt;ffffff8bf28a3668&gt;] do_page_fault+0x2a0&#x2F;0x3e0</span><br><span class="line">[149459.897716] [3:2065:watchdog] [&lt;ffffff8bf28a3364&gt;] do_translation_fault+0x44&#x2F;0xa8</span><br><span class="line">[149459.897732] [3:2065:watchdog] [&lt;ffffff8bf2880b74&gt;] do_mem_abort+0x4c&#x2F;0xd0</span><br><span class="line">[149459.897750] [3:2065:watchdog] [&lt;ffffff8bf2882c78&gt;] el0_da+0x20&#x2F;0x24</span><br><span class="line">[149459.897767] [3:2065:watchdog] Binder:1042_19 D 0 11188 635 0x00000008</span><br><span class="line">[149459.897786] [3:2065:watchdog] Call trace:</span><br><span class="line">[149459.897797] [3:2065:watchdog] [&lt;ffffff8bf28852d4&gt;] _switch_to+0xb4&#x2F;0xc0</span><br><span class="line">[149459.897804] [3:2065:watchdog] [&lt;ffffff8bf3a1f6a0&gt;] _schedule+0x7f0&#x2F;0xad0</span><br><span class="line">[149459.897820] [3:2065:watchdog] [&lt;ffffff8bf3a1f9f0&gt;] schedule+0x70&#x2F;0x90</span><br><span class="line">[149459.897835] [3:2065:watchdog] [&lt;ffffff8bf3a23b00&gt;] schedule_timeout+0x548&#x2F;0x668</span><br><span class="line">[149459.897853] [3:2065:watchdog] [&lt;ffffff8bf2959028&gt;] msleep+0x28&#x2F;0x38</span><br><span class="line">[149459.897868] [3:2065:watchdog] [&lt;ffffff8bf2a1ff38&gt;] shrink_inactive_list+0x118&#x2F;0x998</span><br><span class="line">[149459.897887] [3:2065:watchdog] [&lt;ffffff8bf2a1cb10&gt;] shrink_node_memcg+0xa18&#x2F;0x1100</span><br><span class="line">[149459.897904] [3:2065:watchdog] [&lt;ffffff8bf2a1f0b0&gt;] shrink_node+0x108&#x2F;0x2f8</span><br><span class="line">[149459.897922] [3:2065:watchdog] [&lt;ffffff8bf2a1bcb0&gt;] do_try_to_free_pages+0x178&#x2F;0x380</span><br><span class="line">[149459.897940] [3:2065:watchdog] [&lt;ffffff8bf2a1b9d0&gt;] try_to_free_pages+0x370&#x2F;0x4d8</span><br><span class="line">[149459.897957] [3:2065:watchdog] [&lt;ffffff8bf2a071b8&gt;] __alloc_pages_nodemask+0x868&#x2F;0x1380</span><br><span class="line">[149459.897977] [3:2065:watchdog] [&lt;ffffff8bf2a13784&gt;] _do_page_cache_readahead+0xbc&#x2F;0x358</span><br><span class="line">[149459.897996] [3:2065:watchdog] [&lt;ffffff8bf29fde4c&gt;] filemap_fault+0x11c&#x2F;0x600</span><br><span class="line">[149459.898013] [3:2065:watchdog] [&lt;ffffff8bf2b479f8&gt;] ext4_filemap_fault+0x30&#x2F;0x50</span><br><span class="line">[149459.898031] [3:2065:watchdog] [&lt;ffffff8bf2a47f38&gt;] handle_pte_fault+0xb38&#x2F;0xfa8</span><br><span class="line">[149459.898048] [3:2065:watchdog] [&lt;ffffff8bf2a485c8&gt;] handle_mm_fault+0x1d0&#x2F;0x328</span><br><span class="line">[149459.898065] [3:2065:watchdog] [&lt;ffffff8bf28a3668&gt;] do_page_fault+0x2a0&#x2F;0x3e0</span><br><span class="line">[149459.898083] [3:2065:watchdog] [&lt;ffffff8bf28a3364&gt;] do_translation_fault+0x44&#x2F;0xa8</span><br><span class="line">[149459.898100] [3:2065:watchdog] [&lt;ffffff8bf2880d18&gt;] do_el0_ia_bp_hardening+0xc0&#x2F;0x158</span><br><span class="line">[149459.898118] [3:2065:watchdog] [&lt;ffffff8bf2882c98&gt;] el0_ia+0x1c&#x2F;0x20</span><br></pre></td></tr></table></figure></p>
<p>现象：大量进程从缺页异常入口，调用内存回收接口：shrink_inactive_list -&gt; msleep ，使得该进程状态变为 D.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">msleep</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> msecs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> timeout = msecs_to_jiffies(msecs) + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (timeout)</span><br><span class="line">        timeout = schedule_timeout_uninterruptible(timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">signed</span> <span class="keyword">long</span> __sched <span class="title">schedule_timeout_uninterruptible</span><span class="params">(<span class="keyword">signed</span> <span class="keyword">long</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __set_current_state(TASK_UNINTERRUPTIBLE);</span><br><span class="line">    <span class="keyword">return</span> schedule_timeout(timeout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><table><tr><td bgcolor=    #CD5C5C>D 进程就是被设置了 TASK\_UNINTERRUPTIBLE 进程状态，不可中断的睡眠状态。</td></tr></table><br>不可中断，指的并不是 CPU 不响应外部硬件的中断，而是指进程不响应异步信号，信号只会挂到信号队列，而没有机会去立即执行。它不占用 CPU ，也不能被杀掉，很直观的现象就是，kill -9 一个 D 进程，是没有效果的，只有等进程获得资源被唤醒才处理信号，才处理 SIGKILL。</p>
<p>「进程是很有脾气的，不知道你们有没有遇到那种钻牛角尖的人，拿我儿子来举例一下，有时候他想找到他的玩具火箭，就一直在那里闹，一定要我们帮他找到他的玩具火箭位置，其他事情就是不干，你用坦克哄他也不行，哄他看小猪佩奇也不行。D进程也是一样，必须要等有他等到的那个事件为止」  </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="keyword">static</span> noinline_for_stack <span class="keyword">unsigned</span> <span class="keyword">long</span></span><br><span class="line">    shrink_inactive_list(<span class="keyword">unsigned</span> <span class="keyword">long</span> nr_to_scan, struct lruvec *lruvec,</span><br><span class="line">             struct scan_control *sc, <span class="keyword">enum</span> lru_list lru)</span><br><span class="line">    &#123;</span><br><span class="line">......</span><br><span class="line">      <span class="keyword">while</span> (unlikely(too_many_isolated(pgdat, file, sc, stalled))) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (stalled)</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">/* wait a bit for the reclaimer. */</span></span><br><span class="line">        msleep(<span class="number">100</span>); <span class="comment">////////////////////// 卡在这里</span></span><br><span class="line">        stalled = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="comment">/* We are about to die and free our memory. Return now. */</span></span><br><span class="line">        <span class="keyword">if</span> (fatal_signal_pending(current))</span><br><span class="line">          <span class="keyword">return</span> SWAP_CLUSTER_MAX;</span><br><span class="line">      &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><table><tr><td bgcolor=    #CD5C5C>初步定位：</td></tr></table><br>该函数已经有跳出功能，不会一直卡住，最多 2 次就会退出去。说明是大量的进程疯狂地调用 shrink_inactive_list 又被阻塞了一下子，又退出去，又掉进来。<br>所以，不是一直卡死，而是性能瓶颈拥堵在这个地方，congestion 「拥挤堵车的意思」。<br>从上层 systrace 也能看到，很有规律的大概 110ms 一段的 D 状态，一个进程甚至可以持续几十秒。</p>
<p><img src="1.webp" alt="图片"></p>
<p>说明隔离页面过多，sleep 100ms，猜测目的是</p>
<ol>
<li>给时间处理隔离页面，回写文件页到磁盘  </li>
<li>是控制并发，也许另一个 cpu 也在同样的回收流程导致隔离页在时刻变大。  </li>
</ol>
<p>所以初步定了两个方向和疑点：<br>一是内存回收瓶颈，内存回收不及时，内存需求量巨大，而 LMK 没触发，内存有很多匿名页，都在回收和回写文件页等。<br>二是 io 读写瓶颈，io 速率慢，某个时间段速率变慢，ufs 频率低，上层读写大量数据，io 占用率过高等。<br>需要澄清这些疑点。<br>插播一些背景知识</p>
<h2 id="page-cache"><a href="#page-cache" class="headerlink" title="page cache"></a>page cache</h2><p>导致这个情况的原因是：<br>进程在申请内存的时候，发现该 zone 的 freelist 上已经没有足够的内存可用，所以不得不去从该 zone 的 LRU 链表里回收 inactive 的page，这种情况就是 direct reclaim（直接回收）。direct reclaim 会比较消耗时间的原因是，如果回收的是 dirty page，就会触发磁盘 IO 的操作，它会首先把 dirty page 里面的内容给回写到磁盘作同步，再去把该 page 给放到 freelist 里。</p>
<p>下图来看下 memory，page cache，Disk I/O 的关系。</p>
<p><img src="2.webp" alt="图片"></p>
<p>举个简单的例子，比如我们 open 一个文件时，如果没有使用 O_DIRECT 这个flag，那就是 File I/O, 所有对磁盘文件的访问都要经过内存，内存会把这部分数据给缓存起来；但是如果使用了 O_DIRECT 这个flag，那就是 Direct I/O, 它会绕过内存而去直接访问磁盘，访问的这部分数据也不会被缓存起来，自然性能上会降低很多。</p>
<h2 id="page-reclaim"><a href="#page-reclaim" class="headerlink" title="page reclaim"></a>page reclaim</h2><p>在直观上，我们有一个认知，我们现在读了一个文件，它会被缓存到内存里面，如果接下来的一个月我们一直都不会再次访问它，而且我们这一个月都不会关闭或者重启机器，那么在这一个月之后该文件就不应该再在内存里头了。</p>
<p>这就是内核对 page cache 的管理策略：LRU（最近最少使用）。即把最近最少使用的 page cache 给回收为 free pages。（页框回收算法 PFRA 远没有这么简单）</p>
<p>内核的页回收机制有两种：后台周期性回收和直接回收。</p>
<p>后台回收是有一个内核线程 kswapd 来做，当内存里 free 的 pages 低于一个水位（page_low）时，就会唤醒该内核线程，然后它从 LRU 链表里回收 page cache 到内存的 free_list 里头，它会一直回收直至 free 的 pages 达到另外一个水位 page_high 才停止. 如下图所示：</p>
<p><img src="3.webp" alt="图片"></p>
<p>直接回收则是，在发生 page fault/alloc memory 时，没有足够可用的内存，于是线程就自己直接去回收内存，它一次性的会回收 32 个 pages。逻辑过程如下图所示：</p>
<p><img src="4.webp" alt="图片"></p>
<p>所以，在内存优化上</p>
<ol>
<li>抬高 watermark 可以间接减少内存回收的并发量，减轻卡在 shrink_inactive_list.</li>
<li>提高回收效率，如 LMK 的效率。  </li>
</ol>
<p>然而，还是没彻底解决这个问题，所以我们把疑点再次指向 io。<br>尝试抓取更多的信息，来了解触发瓶颈的微观过程。</p>
<ol>
<li>跑 monkey 增加 io 使用率、io 读写速度监控，以时间片为 100ms，监控连续 D 状态，并收集 D 进程堆栈信息、内存信息等。</li>
<li>打开 ftarce 的 vmscan 和 writeback 两个监控点，apk 监控到持续 D 状态就进dump，从 dump 解析 ftrace，再使用 kernelshark 来观察一些数据。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/events/writeback/enable</span><br><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/events/vmscan/enable</span><br><span class="line">echo 1 &gt; /sys/kernel/debug/tracing/tracing_on</span><br></pre></td></tr></table></figure>
<p>为了准备再深入上述的微观过程，需要再补充一些代码和流程图：<br><img src="5.webp" alt="图片"></p>
<p><img src="6.webp" alt="图片"></p>
<p>注释的代码不贴了，受微信公众号篇幅限制。</p>
<h1 id="ftrace-kernelshark-辅助分析"><a href="#ftrace-kernelshark-辅助分析" class="headerlink" title="ftrace + kernelshark 辅助分析"></a>ftrace + kernelshark 辅助分析</h1><p>执行页面回收中页面状态<br>ftrace 会抓取下面这些信息统计，所以提前了解下。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">reclaim_stat</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_dirty;<span class="comment">// page_list中脏页数</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_unqueued_dirty;<span class="comment">// page_list中脏页但是没有放入块设备请求队列中的页数</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_congested;<span class="comment">// page_list中阻塞的页数</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_writeback; <span class="comment">// page_list中处于回写中但是不是被回收的页数</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_immediate; <span class="comment">//page_list中即回写中而且即将被回收的页数</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_activate;<span class="comment">// page_list中近期被访问过需要添加到 activate list 的页数</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_ref_keep;<span class="comment">// page_list中近期被访问过的页数</span></span><br><span class="line">    <span class="keyword">unsigned</span> nr_unmap_fail;<span class="comment">//解除映射失败的页数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>经过一段时间的老化测试，测试同学终于抓到 log 了。<br><img src="7.webp" alt="图片"></p>
<p>图中显示 nr_dirty，nr_congested，nr_writeback 几乎都是 0，只有零星 nr_activate 被再访问的页面要添加回 active list.  </p>
<p>说明现场不存在 dirty 页面很多，回写 io 遇到瓶颈的情况。这个猜想不成立了。</p>
<p><img src="8.webp" alt="图片"></p>
<p>图中显示在 34 秒内，所有在 pageout() 中的页面，全是 anon 页面，没有 file ?  </p>
<p>查看 writeback trace event。<br><img src="9.webp" alt="图片"></p>
<p>同样，没有很多 writeback 量  </p>
<p>从测试结果看到：</p>
<ol>
<li>apk 监控到的 io 使用率不高</li>
<li>从 ftrace 看到回写量不大</li>
</ol>
<p>通过最新的数据信息，回到之前的两个大方向：</p>
<ul>
<li><del>一是内存紧缺，内存回收不及时，内存需求量大。LMK 没触发，内存有很多匿名页，都在回收和回写文件页等。</del>（抬高水位、加速 LMK 触发，还有复现，不能彻底解决）</li>
<li><del>二是 io 速率慢，某个时间段速率变慢，ufs 频率低，上层读写大量数据，io 占用率过高等。</del>（数据证明，io 量不多，没有瓶颈）</li>
</ul>
<p>那么，之前的两个方向猜想，都落空了。那会是什么意想不到的原因？那回去看看卡住的代码，too_many_isolated 代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __too_many_isolated(struct pglist_data *pgdat, <span class="keyword">int</span> file,</span><br><span class="line">  struct scan_control *sc, <span class="keyword">bool</span> stalled)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> inactive, isolated;</span><br><span class="line">  <span class="keyword">if</span> (file) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stalled) &#123;</span><br><span class="line">      inactive = node_page_state_snapshot(pgdat,</span><br><span class="line">          NR_INACTIVE_FILE);</span><br><span class="line">      isolated = node_page_state_snapshot(pgdat,</span><br><span class="line">          NR_ISOLATED_FILE);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      inactive = node_page_state(pgdat, NR_INACTIVE_FILE);</span><br><span class="line">      isolated = node_page_state(pgdat, NR_ISOLATED_FILE);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stalled) &#123;</span><br><span class="line">      inactive = node_page_state_snapshot(pgdat,</span><br><span class="line">          NR_INACTIVE_ANON);</span><br><span class="line">      isolated = node_page_state_snapshot(pgdat,</span><br><span class="line">          NR_ISOLATED_ANON);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      inactive = node_page_state(pgdat, NR_INACTIVE_ANON);</span><br><span class="line">      isolated = node_page_state(pgdat, NR_ISOLATED_ANON);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * GFP_NOIO/GFP_NOFS callers are allowed to isolate more pages, so they</span></span><br><span class="line"><span class="comment">   * won't get blocked by normal direct-reclaimers, forming a circular</span></span><br><span class="line"><span class="comment">   * deadlock.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> ((sc-&gt;gfp_mask &amp; (__GFP_IO | __GFP_FS)) == (__GFP_IO | __GFP_FS))</span><br><span class="line">    inactive &gt;&gt;= <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">return</span> isolated &gt; inactive;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有很复杂的逻辑，只有简单的 isolated 和 inactive 统计计数比较。所以，只能是更直接的猜想：isolated file 统计一直偏大，导致一直判断 too_many_isolated 为真，卡在 shrink_inactive_list。</p>
<p>根据这个猜想，从 log 中打印的 mem info，也看到 isolated file 一直偏大，一直在增加，不会减少。好像印证了猜想似的。</p>
<p>LOG：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;6&gt;[95299.607369]  isolated(anon):0kB isolated(file):37880kB</span><br><span class="line">&lt;6&gt;[95318.568833]  isolated(anon):0kB isolated(file):37752kB</span><br><span class="line">&lt;6&gt;[95323.773350]  isolated(anon):0kB isolated(file):37752kB</span><br><span class="line">&lt;6&gt;[97520.184804]  isolated(anon):0kB isolated(file):44604kB</span><br><span class="line">&lt;6&gt;[97525.658037]  isolated(anon):0kB isolated(file):44604kB</span><br><span class="line">&lt;6&gt;[97754.256431]  isolated(anon):0kB isolated(file):44604kB</span><br><span class="line">&lt;6&gt;[97759.418172]  isolated(anon):0kB isolated(file):44604kB</span><br><span class="line">&lt;6&gt;[97764.574908]  isolated(anon):0kB isolated(file):44604kB</span><br><span class="line">&lt;6&gt;[97769.735128]  isolated(anon):0kB isolated(file):44604kB</span><br><span class="line">&lt;6&gt;[98543.638667]  isolated(anon):0kB isolated(file):44684kB</span><br><span class="line">&lt;6&gt;[98548.905397]  isolated(anon):0kB isolated(file):44684kB</span><br><span class="line">&lt;6&gt;[98554.209671]  isolated(anon):0kB isolated(file):44684kB</span><br><span class="line">&lt;6&gt;[99996.798031]  isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100002.122853] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100007.359023] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100146.079882] isolated(anon):0kB isolated(file):51700kB</span><br><span class="line">&lt;6&gt;[100151.313065] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100156.587622] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100328.483071] isolated(anon):0kB isolated(file):51700kB</span><br><span class="line">&lt;6&gt;[100520.245217] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100550.688429] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100555.913634] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100669.226582] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100935.069661] isolated(anon):0kB isolated(file):51688kB</span><br><span class="line">&lt;6&gt;[100940.240279] isolated(anon):0kB isolated(file):51572kB</span><br><span class="line">&lt;6&gt;[100945.476071] isolated(anon):0kB isolated(file):51828kB</span><br><span class="line">&lt;6&gt;[103104.120921] isolated(anon):0kB isolated(file):53344kB</span><br><span class="line">&lt;6&gt;[103121.900214] isolated(anon):0kB isolated(file):53344kB</span><br><span class="line">&lt;6&gt;[103481.197823] isolated(anon):0kB isolated(file):53412kB</span><br><span class="line">&lt;6&gt;[103486.555528] isolated(anon):0kB isolated(file):53412kB</span><br><span class="line">&lt;6&gt;[103721.346234] isolated(anon):0kB isolated(file):53412kB</span><br><span class="line">&lt;6&gt;[103726.655700] isolated(anon):0kB isolated(file):53540kB</span><br><span class="line">&lt;6&gt;[103731.961321] isolated(anon):0kB isolated(file):53540kB</span><br><span class="line">&lt;6&gt;[103737.236295] isolated(anon):0kB isolated(file):53540kB</span><br><span class="line">&lt;6&gt;[103742.470632] isolated(anon):0kB isolated(file):53412kB</span><br><span class="line">&lt;6&gt;[103747.661019] isolated(anon):0kB isolated(file):53284kB</span><br><span class="line">&lt;6&gt;[103752.973978] isolated(anon):0kB isolated(file):53412kB</span><br></pre></td></tr></table></figure></p>
<h2 id="柳暗花明又一村"><a href="#柳暗花明又一村" class="headerlink" title="柳暗花明又一村"></a>柳暗花明又一村</h2><p>对 NR_ISOLATED_FILE/NR_ISOLATED_ANON 的统计增减主要分布在 vmscan.c migrate.c，和 PPR (高通进程内存回收)模块。理论上内核 vmscan.c（成双成对） migrate.c 都不会有问题，高通 PPR 模块插入在 vmscan. c 和 task_mmu.c 里，而我们 IMS 没有直接使用高通 PPR，嫌疑最大。于是，在上游确实找到了个相关的 patch。</p>
<p><a href="https://source.codeaurora.org/quic/la/kernel/msm-4.14/commit/fs/proc/task\_mmu.c?h=msm-4.14&amp;id=c800548eac0350391c6d379a89f2e5d4c31366bf" target="_blank" rel="noopener">https://source.codeaurora.org/quic/la/kernel/msm-4.14/commit/fs/proc/task\_mmu.c?h=msm-4.14&amp;id=c800548eac0350391c6d379a89f2e5d4c31366bf</a></p>
<p>这个 patch 正是修复了 isolated count mismatch 的问题，导致一直让 isolated file 增大。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MADV_FREE clears pte dirty bit and then marks the page lazyfree (clear</span><br><span class="line">SwapBacked). PPR increments ISOLATE_FILES count, then isolates page and</span><br><span class="line">invokes a reclaim. Inbetween if this lazyfreed page is touched by user then</span><br><span class="line">it becomes dirty.  PPR in shrink_page_list in try_to_unmap finds the page</span><br><span class="line">dirty, marks it back as PageSwapBacked and skips reclaim. As PageSwapBacked</span><br><span class="line">set, PPR identifies the page as anon and decrements ISOLATED_ANON, thus</span><br><span class="line">creating isolated count mismatch.</span><br><span class="line">This results in too_many_isolated() check causing delay in reclaim. Skip</span><br><span class="line">reclaiming lazyfreed pages in PPR path.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MADV_FREE (since Linux 4.5)</span><br><span class="line">              The application no longer requires the pages in the range</span><br><span class="line">              specified by addr and len.  The kernel can thus free these</span><br><span class="line">              pages, but the freeing could be delayed until memory pressure</span><br><span class="line">              occurs.  For each of the pages that has been marked to be</span><br><span class="line">              freed but has not yet been freed, the free operation will be</span><br><span class="line">              canceled if the caller writes into the page.  After a</span><br><span class="line">              successful MADV_FREE operation, any stale data (i.e., dirty,</span><br><span class="line">              unwritten pages) will be lost when the kernel frees the pages.</span><br><span class="line">              However, subsequent writes to pages in the range will succeed</span><br><span class="line">              and then kernel cannot free those dirtied pages, so that the</span><br><span class="line">              caller can always see just written data.  If there is no</span><br><span class="line">              subsequent write, the kernel can free the pages at any time.</span><br><span class="line">              Once pages in the range have been freed, the caller will see</span><br><span class="line">              zero-fill-on-demand pages upon subsequent page references.</span><br><span class="line">              The MADV_FREE operation can be applied only to private</span><br><span class="line">              anonymous pages (see mmap(2)).  In Linux before version 4.12,</span><br><span class="line">              when freeing pages on a swapless system, the pages in the</span><br><span class="line">              given range are freed instantly, regardless of memory</span><br><span class="line">              pressure.</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">madvise(2) is a system call used by processes to tell the kernel how they are going to use their memory, allowing the kernel to optimize the memory management according to these hints to achieve better overall performance.</span><br><span class="line">When an application wants to signal the kernel that it isn&#39;t going to use a range of memory in the near future, it can use the MADV_DONTNEED flag, so the kernel can free resources associated with it. Subsequent accesses in the range will succeed, but will result either in reloading of the memory contents from the underlying mapped file or zero-fill-on-demand pages for mappings without an underlying file. But there are some kind of apps (notably, memory allocators) that can reuse that memory range after a short time, and MADV_DONTNEED forces them to incur in page fault, page allocation, page zeroing, etc. For avoiding that overhead, other OS like BSDs have supported MADV_FREE, which just mark pages as available to free if needed, but it doesn&#39;t free them immediately, making possible to reuse the memory range without incurring in the costs of faulting the pages again. This release adds Linux support for this flag.</span><br><span class="line">Recommended LWN article: Volatile ranges and MADV_FREE</span><br></pre></td></tr></table></figure>
<p>madvise[1] 系统调用，会建议内核，在从 addr 指定的地址开始，长度等于 len 参数值的范围内，该区域的用户虚拟内存应遵循特定的使用模式，使内核可以选择适当的预读和缓存技术。如果使用 madvise() 函数的程序明确了解其内存访问模式，则使用此函数可以提高系统性能。</p>
<p>自 4.5 开始，引入 MADV_FREE 参数「这是为什么 4.9 内核才出现该问题，这需要上层和底层同时支持，才会出现本问题」。简单来说，MADV_FREE 就是让上层设置一段内存可以释放内存的标志，但是底层并不会立即释放，以便让上层可以在短时间内重复访问，以免增加缺页异常等性能开销。也叫 lazy free，它只能用于匿名页面。</p>
<p>根据描述，触发 isolated file 统计增大的路径是：「代码省略不贴」</p>
<ul>
<li>上层调用 madvise 系统调用，使用 MADV_FREE 时，清除 dirty bit 和 SwapBacked bit，把 lazyfree page 加入 inactive file list。</li>
<li>PPR 增加 ISOLATE_FILES 计数（SwapBacked=0），隔离页面并触发回收</li>
<li>上层访问 lazyfreed 页面，dirty=1</li>
<li>PPR 执行 reclaim_pte_range -&gt; reclaim_pages_from_list -&gt; shrink_page_list -&gt;try_to_unmap -&gt; try_to_unmap_one 设置 SwapBacked=1, 并跳出回收</li>
<li>PPR 继续执行 reclaim_pte_range -&gt; reclaim_pages_from_list，putback_lru_page 的时候，因为 SwapBacked=1，减少了 NR_ISOLATED_ANON 计数，而不是减少当初增加的 NR_ISOLATED_FILE 计数。</li>
<li>导致 NR_ISOLATED_FILE 一直被增加</li>
</ul>
<p>所以，需要在 PPR 中过滤 lazyfree 页面，避免这个 NR_ISOLATED_FILE 计数异常，导致的卡 too_many_isolated。</p>
<p>匿名页面一开始就会设置 SwapBacked=1, 并且只有在上层设置 lazyfree 页面时才会清除 ClearPageSwapBacked(page) ，没别的地方了。所以，PageAnon(page) &amp;&amp; !PageSwapBacked(page) 能指示这是 lazyfree 页面。</p>
<p>ok，已经理清了前因后果。再退一步，试想下，假如上游没有修复这个 patch。我们能不能想出来？我觉得很难，因为我们缺乏 madvise 的相关认识，并且它经过了 dirty, SwapBacked 标志的变化（好像几乎没办法做这么微观的页面标志追踪？），才导致 NR_ISOLATED_ANON/FLIE 的变化。</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><code>[1] madvise: _http://www.man7.org/linux/man-pages/man2/madvise.2.html_</code></p>

                
                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2024/12/06/Submit-patch-implementations-to-the-Linux-kernel-community/" data-toggle="tooltip" data-placement="top" title="向 Linux 内核社区提交 patch 实操要点">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2024/07/12/sub-system-cgroup-freezer-in-Linux-kernel/" data-toggle="tooltip" data-placement="top" title="进程冻结技术：深入探究 Linux 内核中的 cgroup freezer 子系统">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                <!-- tip start -->
                

                
                <div class="comment_notes">
                    <p>
                        This is copyright.
                    </p>
                </div>
                
                <!-- tip end -->

                <!-- Music start-->
                
                <!-- Music end -->

                <!-- Sharing -->
                
                <div class="social-share"  data-wechat-qrcode-helper="" align="center"></div>
                <!--  css & js -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>
                
                <!-- Sharing -->

                <!-- gitment start -->
                
                <!-- gitment end -->

                <!-- 来必力City版安装代码 -->
                
                <!-- City版安装代码已完成 -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      
        <aside id="sidebar">
          <div id="toc" class="toc-article">
          <strong class="toc-title">Contents</strong>
          
            
              <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Description"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Description</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#山重水复疑无路"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">山重水复疑无路</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#page-cache"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">page cache</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#page-reclaim"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">page reclaim</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#ftrace-kernelshark-辅助分析"><span class="toc-nav-number"></span> <span class="toc-nav-text">ftrace + kernelshark 辅助分析</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#柳暗花明又一村"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">柳暗花明又一村</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#References"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">References</span></a></li></ol>
            
          
          </div>
        </aside>
      
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="#" target="_blank">Other</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>


<style  type="text/css">
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">

                

                

                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; meizu 2025 
                    <br>
                    Powered by 
                    <a href="https://github.com/dusign/hexo-theme-snail" target="_blank" rel="noopener">
                        <i>hexo-theme-snail</i>
                    </a> | 
                    <iframe name="star" style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0"
                        width="100px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=dusign&repo=hexo-theme-snail&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>

</footer>

<!-- jQuery -->

<script src="../../../../js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="../../../../js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="../../../../js/hux-blog.min.js"></script>


<!-- Search -->

<script src="../../../../js/search.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://kernel.meizu.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-XXXXXXXX-X';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->


<!-- Search -->

    <script type="text/javascript">      
        var search_path = "search.xml";
        if (search_path.length == 0) {
            search_path = "search.xml";
        }
    var path = "/" + search_path;
    searchFunc(path, 'local-search-input', 'local-search-result');
    </script>


<!-- busuanzi -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>

    
        <!-- background effects line -->
        

        
            <script type="text/javascript" src="/js/mouse-click.js" content='[&quot;🌱&quot;,&quot;just do it&quot;,&quot;🍀&quot;]' color='[&quot;rgb(121,93,179)&quot; ,&quot;rgb(76,180,231)&quot; ,&quot;rgb(184,90,154)&quot;]'></script>
        

        <!-- background effects end -->
    

    <!--<script size="50" alpha='0.3' zIndex="-999" src="/js/ribbonStatic.js"></script>-->
    
        <script src="/js/ribbonDynamic.js"></script>
    
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
